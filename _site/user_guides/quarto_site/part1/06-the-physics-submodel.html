<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Atlantis Documentation – 5. THE PHYSICS SUBMODEL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Atlantis Documentation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-user-guides" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">User Guides</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-user-guides">    
        <li>
    <a class="dropdown-item" href="../../../user_guides/quarto_site/part1/index.html">
 <span class="dropdown-text">Part I - Atlantis User Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../user_guides/quarto_site/part2/index.html">
 <span class="dropdown-text">Part II - [Coming Soon]</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../confluence/index.html"> 
<span class="menu-text">Confluence Wiki</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../resources/index.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../user_guides/quarto_site/part1/06-the-physics-submodel.html">5. The Physics Submodel</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/01-foreward.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Foreword</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/02-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/03-installation-and-running.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. Installation and Running</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/04-geometry-of-the-model-domain.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Geometry of the Model Domain</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/05-hydrodynamic-salinity-and-temperature-forcing-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. Hydrodynamic, Salinity and Temperature Forcing Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/06-the-physics-submodel.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">5. The Physics Submodel</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/07-definitions-of-functional-groups.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6. Definitions of Functional Groups</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/08-run-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7. Run Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/09-force-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8. Force Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/10-primary-producer-processes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9. Primary Producer Processes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/11-consumer-processes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10. Consumer Processes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/12-distribution-and-movement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11. Distribution and Movement</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/13-processes-in-bacterial-and-inanimate-pools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12. Processes in Bacterial and Inanimate Pools</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/14-influence-of-environmental-factors-on-ecological-p.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">13. Influence of Environmental Factors on Ecological Processes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/15-final-overview-of-ecology-routines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">14. Final Overview of Ecology Routines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/16-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/17-appendix-1-tips-for-calibrating-biological-model-n.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix 1: Tips for Calibrating Biological Model</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#physical-and-biogeochemical-variables-and-their-characteristics" id="toc-physical-and-biogeochemical-variables-and-their-characteristics" class="nav-link active" data-scroll-target="#physical-and-biogeochemical-variables-and-their-characteristics"><strong>5.1. Physical and biogeochemical variables and their characteristics</strong></a></li>
  <li><a href="#the-main-physics-routine" id="toc-the-main-physics-routine" class="nav-link" data-scroll-target="#the-main-physics-routine"><strong>5.2. The main <em>physics()</em> routine</strong></a></li>
  <li><a href="#other-parameters-in-physics.prm-not-included-in-the-physics-routine" id="toc-other-parameters-in-physics.prm-not-included-in-the-physics-routine" class="nav-link" data-scroll-target="#other-parameters-in-physics.prm-not-included-in-the-physics-routine"><strong>5.3. Other parameters in <em>physics.prm</em> not included in the <em>physics()</em> routine</strong></a></li>
  <li><a href="#when-to-use-vertical-and-horizontal-transport-and-mixing" id="toc-when-to-use-vertical-and-horizontal-transport-and-mixing" class="nav-link" data-scroll-target="#when-to-use-vertical-and-horizontal-transport-and-mixing"><strong>5.4. When to use vertical and horizontal transport and mixing?</strong></a></li>
  <li><a href="#latest-developments" id="toc-latest-developments" class="nav-link" data-scroll-target="#latest-developments"><strong>5.5. Latest developments</strong></a>
  <ul>
  <li><a href="#land" id="toc-land" class="nav-link" data-scroll-target="#land"><strong><em>5.5.1 Land</em></strong></a></li>
  <li><a href="#ice" id="toc-ice" class="nav-link" data-scroll-target="#ice"><strong><em>5.5.2. Ice</em></strong></a></li>
  <li><a href="#contaminants" id="toc-contaminants" class="nav-link" data-scroll-target="#contaminants"><strong><em>5.5.3. Contaminants</em></strong></a></li>
  </ul></li>
  <li><a href="#outputs-of-physics-tracers-in-the-output.nc-file" id="toc-outputs-of-physics-tracers-in-the-output.nc-file" class="nav-link" data-scroll-target="#outputs-of-physics-tracers-in-the-output.nc-file"><strong>5.6. Outputs of physics tracers in the <em>output.nc</em> file</strong></a></li>
  <li><a href="#importance-of-optional-physics-routines" id="toc-importance-of-optional-physics-routines" class="nav-link" data-scroll-target="#importance-of-optional-physics-routines"><strong>5.7. Importance of optional physics routines</strong></a></li>
  <li><a href="#checking-hydrodynamic-transports" id="toc-checking-hydrodynamic-transports" class="nav-link" data-scroll-target="#checking-hydrodynamic-transports"><strong>5.8. Checking hydrodynamic transports</strong></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">5. THE PHYSICS SUBMODEL</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The Physics submodel deals with most physical and some biogeochemical processes in Atlantis, such as water and gas exchanges and mixing, nutrient inputs, deposition and resuspension of particulate matter, as well as some biological processes in the sediments, such as bioturbation and bioirrigation.</p>
<p>The central part of the Physics submodel is the <strong>transport model</strong> that reads in water exchanges from the hydrodynamic forcing files, applies a number of optional routines to correct for lack of horizontal and vertical mixing (see below), distributes water flows through the model domain, and calculates new concentrations of dissolved or passively advected tracers, such as salinity, temperature, oxygen, pH and pelagic planktonic organisms. These calculations simultaneously account for diffusion, advection and dispersion processes. The transport model is preceded by a number of optional routines executing sediment mixing, resuspension, gas exchange with the atmosphere, bioirrigation and others (see below).</p>
<p>Most of the details in the Atlantis Physics submodel are based on the Port Phillip Bay Integrated Model (PPBIM) described in Murray and Parslow (1997) and Walker (1997) and on the <a href="http://www.meece.eu/library/ersem.html">ERSEM</a> model described in Ebenhöh et al.&nbsp;(1995) (see important references in Chapter 1.5). Atlantis users interested in understanding the physics processes deeper can learn more by consulting these references.</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th><p><strong>The parameters and flags used in the Physics submodel are described in</strong>:</p>
<p>1) <em>initial_conditions.nc</em></p>
<p>2) <em>physics.prm, run.prm</em> and <em>force.prm</em> files</p>
<p>3) <em>hydrodynamics.nc</em> forcing input file</p>
<p>4) optional forcing NC and TS input files, such as temperature, salinity, pH, oxygen, contaminants, point source inputs, solar radiation, evaporation, precipitation and others.</p></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>In this chapter we will:</p>
<p>1) introduce physics and biogeochemical tracers and their properties,</p>
<p>2) describe the routines executed in the main <em>physics()</em> routine and parameters in the <em>physics.prm</em> file</p>
<p>3) explain why in some cases the user might need to correct for the lack of the vertical and horizontal mixing in hydrodynamic forcing files</p>
<p>4) give a brief introduction to the latest Atlantis developments allowing for the modelling of ice, land and contaminants</p>
<p>5) provide a small example demonstrating the importance of the optional physics routines</p>
<section id="physical-and-biogeochemical-variables-and-their-characteristics" class="level2">
<h2 class="anchored" data-anchor-id="physical-and-biogeochemical-variables-and-their-characteristics"><strong>5.1. Physical and biogeochemical variables and their characteristics</strong></h2>
<p>The <em>initial_conditions.nc</em> file lists important characteristics of physical and biogeochemical tracers, used for various calculations in the <em>physics()</em> routine. Here is an example of a tracer description:</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th><p>…</p>
<p>double Det_Si(t, b, z) ;</p>
<p>Det_Si:bmtype = "tracer" ;</p>
<p>Det_Si:units = "mg Si m-3" ;</p>
<p>Det_Si:long_name = "Detrital Silica" ;</p>
<p>Det_Si:dtype = 0 ;</p>
<p>Det_Si:sumtype = 1 ;</p>
<p>Det_Si:inwc = 1 ;</p>
<p>Det_Si:insed = 1 ;</p>
<p>Det_Si:decay = 0. ;</p>
<p>Det_Si:dissol = 0 ;</p>
<p>Det_Si:passive = 1 ;</p>
<p>Det_Si:partic = 1 ;</p>
<p>Det_Si:svel = -2.894e-005 ;</p>
<p>Det_Si:xvel = 0. ;</p>
<p>Det_Si:psize = 1.e-005 ;</p>
<p>Det_Si:b_dens = 1000000000. ;</p>
<p>Det_Si:i_conc = 200000000. ;</p>
<p>Det_Si:f_conc = 200000000. ;</p>
<p>…</p></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>From this we can see that Det_Si is a three-dimentional variable (t,b,z), found in the water column (inwc=1) and the sediments (insed=1). It is not removed from the system through burial (decay=0), it is not dissolved in the water (dissol=0), but is present in a particulate form (partic=1). The sedimentation velocity of particles is svel=-2.894e-005, and its negative value shows that the particles sink (are not buoyant). The particle size is psize = 1.e-005 m</p>
<p><span id="_Toc526762758" class="anchor"></span>Table 6. Examples of currently used obligatory and optional physics and biogeochemical tracers and variables and their characteristics as defined in the <em>initial_conditions.nc</em> file (collected from different Atlantis applications and used for illustration purposes only). Further description of tracers and physics variables is given in the following chapters on sediment and biological processes.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><strong>Tracer</strong></th>
<th style="text-align: center;"><strong>Name</strong></th>
<th style="text-align: center;"><strong>In water</strong></th>
<th style="text-align: center;"><strong>In sed</strong></th>
<th style="text-align: center;"><strong>Dissol-ved</strong></th>
<th style="text-align: center;"><strong>Parti-culate</strong></th>
<th style="text-align: center;"><strong>Decay</strong></th>
<th style="text-align: center;"><strong>Svel</strong></th>
<th style="text-align: center;"><strong>Psize</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td colspan="9" style="text-align: center;"><em><strong>Obligatory tracers for dynamic properties</strong>. These tracers participate in ecological processes and change as a result. It is very important to get the characteristics of these tracers correct in the initial_conditions.nc file as Atlantis will use them for dynamic calculations.</em></td>
</tr>
<tr class="even">
<td style="text-align: center;">NH3</td>
<td style="text-align: center;">Ammonia</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">1.e-007</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: center;">NO3</td>
<td style="text-align: center;">Nitrate</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">1.e-009</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="even">
<td style="text-align: center;">DON</td>
<td style="text-align: center;">Dissolved organic nitrogen</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: center;">MicroNut</td>
<td style="text-align: center;">Micronutrients</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="even">
<td style="text-align: center;">Oxygen</td>
<td style="text-align: center;">Oxygen</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Si</td>
<td style="text-align: center;">Dissolved silica</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="even">
<td style="text-align: center;">Det_Si</td>
<td style="text-align: center;">Detrital silica</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">-2.9e-005</td>
<td style="text-align: center;">1.0e-005</td>
</tr>
<tr class="odd">
<td colspan="9" style="text-align: center;"><p><em><strong>Optional tracers for dynamic properties.</strong> Required only if</em></p>
<p><em><sup>1</sup> <strong>-</strong> trackAtomicRatio flag is set to 1 or <sup>2</sup> -</em> <em>flagIsEstuary flag is set to 1 in the run.prm file</em></p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Tracer</strong></td>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;"><strong>In water</strong></td>
<td style="text-align: center;"><strong>In sed</strong></td>
<td style="text-align: center;"><strong>Dissol-ved</strong></td>
<td style="text-align: center;"><strong>Parti-culate</strong></td>
<td style="text-align: center;"><strong>Decay</strong></td>
<td style="text-align: center;"><strong>Svel</strong></td>
<td style="text-align: center;"><strong>Psize</strong></td>
</tr>
<tr class="odd">
<td style="text-align: center;">P<sup>1</sup></td>
<td style="text-align: center;">Phosphorus</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">TOP<sup>1</sup></td>
<td style="text-align: center;">Total organic phosphorus</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Tracer</strong></td>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;"><strong>In water</strong></td>
<td style="text-align: center;"><strong>In sed</strong></td>
<td style="text-align: center;"><strong>Dissol-ved</strong></td>
<td style="text-align: center;"><strong>Parti-culate</strong></td>
<td style="text-align: center;"><strong>Decay</strong></td>
<td style="text-align: center;"><strong>Svel</strong></td>
<td style="text-align: center;"><strong>Psize</strong></td>
</tr>
<tr class="even">
<td style="text-align: center;">Carbon<sup>1</sup></td>
<td style="text-align: center;">Carbon</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">CO2<sup>1</sup></td>
<td style="text-align: center;">Carbon dioxide</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">SED<sup>2</sup></td>
<td style="text-align: center;">Sediments</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">-2.0e-005</td>
<td style="text-align: center;">5.0e-006</td>
</tr>
<tr class="odd">
<td colspan="9" style="text-align: center;"><em><strong>Obligatory diagnostic tracers for physical properties and reporting of biogeochemical processes.</strong> These tracers either describe pure physical properties (temperature, light, stress) or outcomes of other processes, e.g.&nbsp;chl_a concentration is a result of primary production and consumption. The properties of these tracers are hardwired in the Atlantis code and the values in the initial_condition.nc file are overwritten during simulations.</em></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Tracer</strong></td>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;"><strong>In water</strong></td>
<td style="text-align: center;"><strong>In sed</strong></td>
<td style="text-align: center;"><strong>Dissol-ved</strong></td>
<td style="text-align: center;"><strong>Parti-culate</strong></td>
<td style="text-align: center;"><strong>Decay</strong></td>
<td style="text-align: center;"><strong>Svel</strong></td>
<td style="text-align: center;"><strong>Psize</strong></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Salt</td>
<td style="text-align: center;">Salinity</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="even">
<td style="text-align: center;">Temp</td>
<td style="text-align: center;">Temperature</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Light</td>
<td style="text-align: center;">Light intensity on the surface of a cell</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="even">
<td style="text-align: center;">Stress</td>
<td style="text-align: center;">Surface Stress</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Denitrification</td>
<td style="text-align: center;">Denitrification</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">Porosity</td>
<td style="text-align: center;">Sediment porosity</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Nitrification</td>
<td style="text-align: center;">Nitrification</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">Chl_a</td>
<td style="text-align: center;">Chlorophyll</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">x</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td colspan="9" style="text-align: center;"><em><strong>Diagnostic tracers.</strong> They are required in the initial_conditions.nc file and are used during debugging for reporting fine scale information about the group that is tagged by which_check parameter in the run.prm file</em></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Tracer</strong></td>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;"><strong>In water</strong></td>
<td style="text-align: center;"><strong>In sed</strong></td>
<td style="text-align: center;"><strong>Dissol-ved</strong></td>
<td style="text-align: center;"><strong>Parti-culate</strong></td>
<td style="text-align: center;"><strong>Decay</strong></td>
<td style="text-align: center;"><strong>Svel</strong></td>
<td style="text-align: center;"><strong>Psize</strong></td>
</tr>
<tr class="odd">
<td style="text-align: center;">DiagNGain</td>
<td style="text-align: center;">Gain in checked group</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">DiagNLoss</td>
<td style="text-align: center;">Loss in checked group</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">DiagNFlux</td>
<td style="text-align: center;">Flux in checked group</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
</section>
<section id="the-main-physics-routine" class="level2">
<h2 class="anchored" data-anchor-id="the-main-physics-routine"><strong>5.2. The main <em>physics()</em> routine</strong></h2>
<p>The routine <em>physics()</em> defined in <strong>atphysics.c</strong> is the main physics routine, run at each timestep of the simulation. It is described below in the order of execution. The first column lists the routines, the flags to activate them, and shows which flags are active in the example SETas model. The second column describes routines and parameters. Remember that (as elsewhere in this manual) routines are listed in <em>italics() and</em> files containing these routines are bold and <strong><u>underlined</u></strong> and libraries are <strong>bold</strong>. Parameter names from <em>physics.prm</em> are given <strong>in orange</strong> and those from <em>force.prm</em> file are also marked with an asterisk *.</p>
<p><strong>I. Execute explicit optional physics processes.</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><p>Add sources and sinks</p>
<p><em>sourceSink()</em> in <strong><u>atsourcesink.c</u></strong></p>
<p>injection</p>
<p>1</p></th>
<th><p>Applies forced inputs and outflows of water and nutrients from point sources, including evaporation and precipitation</p>
<p>The number of point sources and sinks is given in npointss<strong>*</strong>. The inputs are read in as time series TS or NC files and they give details on inflow or outflow of water (m<sup>3</sup>, temp, salinity) and nutrients (NH3, NO3, Labile Detritus, Si). They are also used to force nutrient inputs from river inflows, upwelling, waste disposal and other sources. Theoretically sinks of nutrients and water flows can also be included (negative values in the forcing files), but this has not typically been applied in practice.</p>
<p>The <em>sourceSink()</em> routine also deals with water exchanges due to evaporation (Evaporation<strong>*</strong>) and precipitation (Precipitation<strong>*</strong>).</p>
<p>If the injection flag is set to 0 then evaporation and precipitation will not be done at all. Note that evaporation and precipitation forcing files are provided as two-dimensional NC files, with the values given as millimetres of water input or lost on a xy coordinate grid. These inputs are automatically converted to the Atlantis box geometry by the model.</p></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Add solar radiation</p>
<p><em>do_light()</em> in</p>
<p><strong><u>light.c</u></strong></p>
<p>solar_radiation</p>
<p>1</p></td>
<td><p>Add solar radiation energy to the surface of the model domain (Solar_radiation<strong>*</strong>). If forcing TS files of solar radiation are provided solar radiation intensity at each time step will be identical across the entire surface area of the model domain.</p>
<p>This can be changed by setting lim_sun_hours to 1 in <em>biology.prm</em>, which will apply a set of NASA routines to calculate sun hours for each box given its longitude (using lat/long projections from the BGM file)</p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p>Exchange of gasses between the surface water layer and atmosphere</p>
<p><em>gasExchange()</em> in <strong><u>atgas.c</u></strong></p>
<p>atmospherics</p>
<p>1</p></td>
<td><p>Executes <strong>temperature independent</strong> gas exchange with the atmosphere across the water-air interface at the top of the surface layer. This calculates new concentrations of gases in the surface layer and it assumes an infinite source of gases in the atmosphere.</p>
<p>Gas exchange with the surface water layer is governed by the diffusion coefficient, saturation value and stagnant layer thickness of the gas. These coefficients and gases to be used in the routine are hardwired in Atlantis code and defined in the <strong>gaslist[]</strong> data structure in the <strong><u>atgas.c</u></strong> library. Currently only O2 and CO2 are included.</p>
<p>Note that <em>gasExchange()</em> is not the only routine dealing with input of gases from the atmosphere. There is now an option to include explicit deposition of <a href="https://confluence.csiro.au/display/Atlantis/2014/07/10/Atmosphere-sea+fluxes+of+nutrients+and+gases">nutrients and gases from the atmosphere</a>, including O2 and CO2 (see description of include_atmosphere flag below). The include_atmosphere option deals with deposition of nutrients and gases trapped in particulate matter. It is handled in the specific routines defined in <strong><u>atNutrient.c</u></strong> library <strong>atecology</strong> - e.g.&nbsp;O2 is handed by <em>Oxygen_ROC()</em> routine. The deposition of O2 in <em>Oxygen_ROC()</em> is <strong>temperature-specific</strong>.</p>
<p><strong>If both include_atmosphere and atmospherics flags are turned off there will be no O2 exchange with the atmosphere!</strong></p></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Decay or removal of tracers from the water column and / or sediments.</p>
<p><em>decayBM()</em> in <strong><u>atdecay.c</u></strong></p>
<p>decay_wc</p>
<p>decay_sed</p>
<p>0 0</p></td>
<td><p>Removes tracers from the system, simulating burial in the sediments. The exponent of the removal rate is given in the <em>initial_conditions.nc</em> file :decay parameter, so that removal rate is calculated as [tracer_concentration*exp(:decay*time)]. The removal rate in the sediments can be scaled to that in the water column with decay_sed_scale parameter to set as a multiplier on the standard :decay rate. If the :decay parameter of a tracer is set to 0 in the <em>initial_conditions.nc</em>, no removal of the tracer will occur even if the routine is activated.</p>
<p>Note, the <em>decayBM()</em> routine implements a complete removal of the tracer from the system, not the actual decomposition decay. Even if the decay is deactivated a tracer can still break down through nitrification and denitrification processes. In this case however its nitrogen content may not be entirely removed from the system, but can be transformed into other tracers as specified by the nutrient cycling steps (e.g.&nbsp;organic N is transformed into NO3).</p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p>Resuspension of <strong>particulate</strong> tracers from the sediments into water column</p>
<p><em>resuspendBM()</em> in <strong><u>atsuspension.c</u></strong></p>
<p>resuspension</p>
<p>0</p></td>
<td><p>Calculates erosion of sediments due to shear (bottom) stress as a function of sediment type. Then calculates new concentrations of particulate tracers in the bottom water column layer after the resuspension.</p>
<p>The rate of resuspension depends on the bottom stress, porosity of the sediment and background erosion rate. These parameters are given in the <em>initial_conditions.nc</em> file. The bottom stress can also be supplied as an external BottomStress* forcing file.</p>
<p>To enable the routine, the user <strong>must</strong> provide non-zero stress values. This can be done either by giving non-zero values for the “Stress” tracer in the <em>initial_conditions.nc</em>; or, if NC Stress values are zero, Atlantis will look for an external forcing file. If no forcing file can be found, Atlantis will quit.</p>
<p>The maximum rate for a 1cm sediment depth is set in the max_erosion (m in a single time step). The routine is particularly important when simulating wetlands (shallow ecosystems with many sediment layers).</p></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Settling of <strong>particulate</strong> tracers from the water column</p>
<p><em>settleBMwc()</em> in <strong><u>atsettle.c</u></strong></p>
<p>settling</p>
<p>1</p></td>
<td><p>Calculates settling (<strong>downward or upward!</strong>) of <strong>particulate</strong> tracers from the water column depending on their settling velocity :svel parameter in initial_conditions.nc. <strong>Only tracers with non-zero :svel and :psize will be acted upon</strong>. This typically includes particulate biogeochemical tracers (Detrital Si) and some phyto- and zooplankton.</p>
<p>If settling velocity is positive, particles are buoyant and rise up through the water column (done in the <em>advect_up()</em> routine). If settling velocity is negative, particles sink towards the bottom (done in the <em>advect_down()</em> routine).</p>
<p>The flux of tracers from the lowest water column layer is added to the uppermost sediment layer if the tracer is allowed to exist in the sediments (:insed parameter in <em>initial_condition.nc</em>). The deposition to sediments is done in the <em>deposit()</em> routine in <strong><u>atdeposition.c</u></strong>.</p>
<p>The deposition depends on the sediment’s and tracer’s porosity. The porosity of the tracers is calculated in the <em>calc_por()</em> routine in <strong>atsedprops.c</strong> using the :psize (particle size) and :b_dens (bulk density) parameters from the <em>initial_condition.nc</em> file. Sediment porosity is set as a “phys” variable in the <em>initial_conditions.nc</em> file. However, if the settling routine is turned on sediment porosity is calculated dynamically through the simulation in the <em>deposit()</em> routine. The sediment porosity is calculated as a ratio of the new water volume in the sediment, after deposition, and the total sediment volume, after deposition.</p>
<p>If a particulate tracer is not allowed to exist in the sediment (:insed is 0 in <em>initial_conditions.nc</em> file), it is retained in the lowest water column layer.</p>
<p>The <em>deposit()</em> routine uses the maxseddz and minseddz parameters to define the maximum and minimum depth of one sediment layer.</p>
<p>If the maxseddz is exceeded everything extra will stay in the bottom water layer and no more deposition will occur.</p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p><strong>II. Execute optional biological sediment processes – bioirrigation and bioturbation:</strong></p>
<p>The bioirrigation and bioturbation routines simulate exchange of dissolved and particulate tracers respectively between sediment layers and between the bottom water column layer and the sediment. The baseline bioirrigation and bioturbation routines have been adopted from the PPBIM. However, Atlantis now also applies a multiplier to the baseline rate, which depends on the biomass of the living organisms in the sediment layers. The multiplier is calculated in the Biology submodel and will be described in the relevant chapter.</p>
<p><strong>The bioturbation routine is only performed when more than one sediment layer is present! Because most models have only one sediment layer, the only way particulate tracers can be returned to the water column is through resuspension.</strong></p>
<p>The full bioirrigation routine also requires more than one sediment layer, but it models simple exchange of dissolved particles even in models with only one sediment layer.</p>
<p>The processes used in Atlantis are similar to those in the PPBIM model, but are dynamically modified by the sediment fauna via an “enhancement” term (similar to that of <a href="http://www.meece.eu/library/ersem.html">ERSEM</a>, Ebenhöh et al.&nbsp;1995).</p>
<p><strong>The “background density” of sediment organisms is set in the <em>initial_conditions.nc</em> file sedbiodens tracer</strong> and it can vary among boxes. Background density represents basic aerobic and anaerobic diversity. This background amount is “enhanced” depending on the abundance of the dynamically modelled infauna and epifauna groups (identified with _INF and _EP names in the GroupType parameter of the <em>functional_groups.csv</em> file). The abundance of dynamically modelled groups changes through time but the background density stays stable. The background biological activity remains present in sediments even if all dynamically modelled groups are wiped out (e.g.&nbsp;in anoxic sediments). Hence bioturbation, bioirrigation and other sediment processes can still occur (if activated).</p>
<p>Bioturbation and bioirrigation are simulated as exchange in thin water and sediment layers, as shown below. The routines take a small sliver of the water layer and sediment layer, swaps them and calculates new concentrations of dissolved and particulate tracers respectively. The thickness of the sliver to be exchanged reflects the intensity of the bioirrigation and bioturbation processes and depends on the amount of the biological activity in the sediment.</p>
<p><img src="media/image30.jpeg" style="width:4.82in;height:1.59333in"> |</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Bioirrigation: Inflow of water and <strong>dissolved</strong> tracers from the bottom water layer into sediments due to biological activity</p>
<p><em>bioirrig()</em> in <strong><u>atbioirrig.c</u></strong></p>
<p>bioirrigation</p>
<p>1</p></td>
<td><p><em>bioirrig()</em> includes three subroutines (only the last two are done in models with one sediment layer):</p>
<p><em>dissol_diff()</em> calculates diffusion of dissolved tracers across the sediment layers, <strong>if more than one sediment layer is present</strong>. This is calculated as a product of:</p>
<p><strong>-</strong> bi_dissol_kz diffusion constant at zero depth (m<sup>2</sup>s<sup>-1</sup> per animal per m<sup>2</sup>), where the amount of animals per m<sup>2</sup> is set in the <strong>sedbiodens</strong> tracer in the <strong><em>initial_conditions.nc</em></strong> file.</p>
<p>- density of biological activity of _INF and _EP groups</p>
<p>- scalar of biological activity as a function of depth (which depends on the profile described in the biosedprofile)</p>
<p>- scalar of irrigation enhancement due to oxygen concentration</p>
<p><em>exchange()</em> applies the inflow of water and dissolved tracers between bottom water layer and sediments, depending on the concentration of the tracer. This can be seen as a passive exchange of dissolved tracers depending on their concentrations. It is calculated as a product of</p>
<p><strong>-</strong> bi_exchange constant (ms<sup>-1</sup> per animal per m<sup>2</sup>)</p>
<p>- area of the sediment/water interface</p>
<p>- density of biological activity</p>
<p>- scalar of irrigation enhancement</p>
<p><em>injection()</em> does injection of water and dissolved tracers form bottom water layer into sediments, simulating active pumping of water by animals moving in burrows</p>
<p><strong>-</strong> bi_injection constant at zero depth (m<sup>2</sup>s<sup>-1</sup> per animal per m<sup>2</sup>)</p>
<p>- area of the sediment/water interface</p>
<p>- density of biological activity</p>
<p>- scalar of irrigation enhancement</p>
<p>The profile of biological activity with depth is set by the biosedprofile parameter, which can take four functional forms: constant, linear, parabolic, Gaussian</p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p>Bioturbation: movement of <strong>particulate</strong> tracers throughout the sediment layers and into the water column due to biological activity. <strong>This routine works only if more than one sediment layer is present</strong></p>
<p><em>bioturb()</em> in <strong><u>atbioturb.c</u></strong></p>
<p>bioturbation</p>
<p>1</p></td>
<td><p>Only <strong>particulate</strong> tracers that are not macrobenthos and are allowed in the sediments, i.e.&nbsp;sediment grains, settled phytoplankton, microphytobenthos, meiobenthos, detritus and sediment bacteria, can be acted upon by bioturbation.</p>
<p>The <em>bioturb()</em> routine includes three subroutines (like the <em>bioirrig()</em> routine described above):</p>
<p><em>partic_diff()</em> implements particulate tracer diffusion within the sediments and is implemented in the same way as diffusion of dissolved tracers in the <em>dissol_diff()</em> subroutine described above. The diffusion rate is calculated as a product of:</p>
<p>- the diffusion constant bt_partic_kz (m<sup>2</sup>s<sup>-1</sup> per animal per m<sup>2</sup>)</p>
<p>- density of biological activity</p>
<p>- scalar of biological activity as a function of depth (which depends on the profile described in the biosedprofile)</p>
<p>- scalar of bioturbation enhancement</p>
<p><em>expul()</em> applies expulsion of particulate tracers from sediments into the bottom water column. Like above, its constant is set by the bt_expulsion parameter (ms<sup>-1</sup> per animal per m<sup>2</sup>), which is modified by the biomass density, scaling by depth and the bioturbation enhancement scalar.</p>
<p><em>mix_in()</em> applies exchange of particulate matter across sediment layers. The exchange constant is set in bt_exchange (ms<sup>-1</sup> per animal per m<sup>2</sup>) which is modified by biomass density, scaling by depth, and bioturbation enhancement scalar</p></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p><strong>III. Execute optional routines to enhance horizontal and vertical diffusion and mixing</strong></p>
<p><strong>(see chapter 5.4 for why these routines may be needed):</strong></p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p>Horizontal diffusion</p>
<p><em>hdiffBMwc()</em> in <strong><u>athdiff.c</u></strong></p>
<p>horiz_diffusion</p>
<p>0</p></td>
<td><strong>Horizontal diffusion is done before the main transport model is run. This was mostly needed in the past, when oceanographic models and their conversion to Atlantis forcing files did not provide sufficient horizontal mixing.</strong></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p><a href="https://confluence.csiro.au/display/Atlantis/2014/05/13/Padding+out+mixing">Filler horizontal diffusion</a> <strong>applied for boxes that have not had any water exchanges for a set period of time</strong></p>
<p><em>filler_hdiffBMwc()</em> in <strong><u>athdiff.c</u></strong></p>
<p>fill_zero_exchange</p>
<p>0</p></td>
<td><p>Hydrodynamic models don't always resolve coastlines well, which can lead to some small coastal boxes being left isolated (no water fluxes into or out of them). This optional routine is used to correct for this. It is activated if there is no flux for a set threshold of days, provided in the flush_threshold (often set to 1 day). The routine will force mixing between the isolated box and matching layers of the adjacent boxes.</p>
<p>The routine will apply a constant water column mixing coefficient wc_kz, which indicates the proportion of volume to be mixed (a reasonable value is within a range of 1e-9) and scale it by the relative box volumes.</p>
<blockquote class="blockquote">
<p>The horizontal mixing can be further tuned using box-specific horizontal mixing parameter boxID:horizmix from the BGM file.</p>
<p>To activate this box specific mixing set use_fill_horizmix to 1. Otherwise the baseline diffusion rate among boxes is used.</p>
</blockquote></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p>Vertical diffusion added to correct for the lack of vertical circulation (this is not the same as vertical mixing used to imitate eddies, see below)</p>
<p><em>atvdiffBMwc()</em> in <strong><u>atvdiff.c</u></strong></p>
<p>vert_diffusion</p>
<p>0</p></td>
<td><p>Vertical diffusion executed throughout the water layers before the main transport model.</p>
<p>Setting flag mix_deep to 1 activates the replenishment of nutrients in the deep layers of oceanic boxes (those that have open water boundary with deep waters) and set the depth value for deep ocean layers in mix_deep_depth parameter. Nutrient values in the bottom layer of boxes that are deeper than mix_deep_depth will be reset to the original value given in the <em>initial_conditions.nc</em></p>
<p>The nutrients that will be reset are: NH3, NO3, Si, MicroNut and also Phosphorus and Carbon if they are tracked throughout the simulations (trackAtomicRatio flag is set to 1 in the <em>run.prm</em>)</p></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Vertical mixing added to simulate upwelling and increased mixing by eddies</p>
<p><em>vertical_mixing()</em> in <strong><u>atvmix.c</u></strong></p>
<p>vert_mix</p>
<p>1</p></td>
<td><p>Because processes within one cell are considered uniform, explicit representation of eddies and upwelling would require a lot of small boxes, untenable for Atlantis models. Instead the supply of nutrients from deeper water levels by eddies and upwelling can be represented with this optional vertical mixing routine. The routine applies season and box specific vertical water column mixing, in addition to the vertical exchange forced through hydrodynamic files.</p>
<p>The main difference between vertical diffusion routine above and vertical mixing is that diffusion is typically a slower process of movement from high to low concentration rates. Mixing in turn simulates advection (movement by water currents) and is usually much faster than diffusion. Also vertical mixing can be customised to vary across boxes and seasons.</p>
<p>The total mixing rate (in m<sup>3</sup>s<sup>-1</sup>) is calculated from lower layer up as a product of</p>
<p>- mix_injection coefficient (1e-3)</p>
<p>- Box specific :vertmix scalar defined in the BGM file</p>
<p>- seasonal scale</p>
<p>- eddy scale</p>
<p>- volume of the box</p>
<p>Note that the sign of the global mix_injection and box-specific :vertmix parameters defines the <strong>direction of vertical mixing</strong>. Usually these coefficients are positive, which means the water will flow upwards, but in theory they can also be negative. Either way, <strong>in vertical mixing routine water flows only in one vertical direction</strong> <strong>(up or down)</strong>.</p>
<p>The seasonal scale is modelled as a sine shaped wave (sin(2.0*3.1415*(day_of_the_year-31.0)/365.0) and it’s fluctuations can be increased by setting the mix_season_kz multiplier (set to 10 in SETas model).</p>
<p>The effect of eddies (eddy scale) is activated with eddy_vertmix flag. It can be tuned with two parameters. First, box-specific eddy strengths per each quarter of the year (the model linearly interpolates between these to get eddy strength on any one day) are set with eddy_S1 to eddy_S4. These eddy parameters are used also in scaling <em>Primary_Production()</em> in <strong><u>atprocess.c</u></strong> in the <strong>atecology</strong> library. Therefore, to allow for different effect on primary production and vertical mixing by eddies, the vertical mixing has specific parameter eddy_vertmix. Vertical mixing can further be further scaled with the global scaling coefficient eddy_mixscale</p>
<p>As in the vertical diffusion routine above, activating the flag mix_deep will reset nutrient concentrations in the deepest layers of oceanic boxes</p>
<p>The vertical mixing code within Atlantis to represent exchange between vertical layers is used to represent changes in upwelling or changes in mixing due to (seasonal or long term) modifications of mixed-layer depth that is not sufficiently captured in the hydrodynamics file.</p>
<p>To activate this code set vert_mix to 1 in the <em>physics.prm</em> file. Then in the <em>forcing.prm</em> file add the pointers to the relevant file of scalars:</p>
<p># Vertical mixing scalar files</p>
<p>use_VertMixFiles 1</p>
<p>vertMixScalar_rewind 0</p>
<p>nvertMixScalarfiles 1</p>
<p>vertMixScalar0.name inputs/Filename_VertMix.nc</p>
<p>The structure of the Filename_VertMix.nc is the same as for the temperature or salinity files – i.e.&nbsp;a value per layer per box per timestep included in the file. The equation used to apply the modified vertical mixing is</p>
<p><span class="math display">\[mix_{rate} = mix_{injection}*vertmix*vertmix_{scale}*eddy_{scale}*seasonal_{scale}*{vol}_{box,layer}\]</span></p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><img src="media/image31.jpeg" style="width:7.07107in;height:4.27358in"> |</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><span id="_Toc526762788" class="anchor"></span>Figure 8. Illustration of optional physics routines described in detail above. Some boxes have two sediment layers. Vertical mixing can also be set as downwelling, but only one direction is possible in a given simulation.</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p><strong>IV. Execute the main transport model</strong></p>
<p>Although there is an option to turn the transport model off (advect_diffusion 0) this should <strong>only be done for debugging purposes</strong> as it <strong>stops all water fluxes</strong> in the model domain. Also note that if you turn off the transport model this will stop the the t.hd timestep from incrementing. The timestep is the timestep from the hydro model. It is also used to read in data from the point source input files. So if you turn off the transport model the values read in from the point source files will always be the value corresponding to the first hydro timestep (the first time value in the first hydro forcing file).</p>
<p>The transport model has an option to scale all transport forced from hydrodynamic input file. This is set by setting scale_transport flag to 1 or 2.</p>
<p>If scale_transport is set to 1, the transport will be scaled by prcnt_exchange parameter. For example, setting prcnt_exchange to 0.5 will half all the horizontal and vertical transport, in some older models this was needed to help correct for hyperdifussion.</p>
<p>If scale_transport flag is set to 2, all transport is scaled by the area of the box and ka_exchange multiplier. The area corrected exchanges are multiplied by ka_exchange before they are used (transport_scalar = ka_exchange / box_area). This helps to ensure the transport is not scaled down too much.</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th><p>NOTE!</p>
<p><strong>Do not scale transport by box area if hyperdifussion correction by box area has already been done during the forcing file construction stage, such as in the Hydroconstruct package (see above).</strong></p></th>
</tr>
</thead>
<tbody>
</tbody>
</table></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Main (advective) transport model</p>
<p><em>transportBM()</em> in</p>
<p><strong>attransport.c</strong></p>
<p>advect_diffusion</p>
<p>1</p></td>
<td><p>This routine executes all forced water fluxes (moves water across cells) and calculates new concentrations of tracers.</p>
<p>Transport model also has a cascade_flows flag which executes transport among boxes with large differences in vertical layers. If cascade_flows is set to 0 the loop calculating transport will only go through the number of water columns in the existing box, if it is set to 1 it will go through the number of water columns in both of the exchanging boxes.</p>
<p>The <em>transportBM()</em> routine calculates new concentrations of tracers, including temperature, salinity and pH. These calculations are done separately in the <em>Properties_At_Depth()</em> routine in <strong>atbiophysics.c</strong> in the <strong>atecology</strong> library. The calculated values are then overwritten if temperature, salinity, pH or other forcing files are provided (see below). The temperature calculations use baseline_temp and temp_ampltiude parameter and will be described in chapters dealing with Biology submodel.</p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>V. Read in temperature, salinity and other tracer forcing values and overwrite values calculated in the transport model</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Read in forcing files for temperature, salinity, pH or other forced tracers and overwrite calculated values</p>
<p><em>tracerForcingBM()</em> in <strong>attempsalt.c</strong></p>
<p>use_tempfiles* 1</p>
<p>use_saltfiles* 1</p>
<p>use_pHfiles* 0</p>
<p>use_force_tracers* 0</p></td>
<td><p>The calculations of tracer values done in the <em>transportBM()</em> routine are overwritten if forced values are provided and appropriate flags activated in the <em>force.prm</em> file</p>
<p>Typically, Atlantis models include temperature and salinity forcing (Table 5), but also pH, oxygen and other tracers set in the <em>initial_conditions.nc</em> can be forced. Such forcing is done if calculations of tracer concentrations done in Atlantis are deemed to be of insufficient accuracy and better information is available from more specialised models or observations (see <a href="https://confluence.csiro.au/display/Atlantis/2013/07/10/Read+in+forcing+data+for+tracers">tracer forcing</a> on the wiki)</p>
<p>The number and names of all tracer forcing files must be listed in the <em>force.prm</em> parameters nforceTracers<strong>*</strong> and tracerNames<strong>*</strong>, eg:</p>
<p>nforceTracers 2</p>
<p>tracerNames 2</p>
<p>Oxygen Light</p>
<p>This is followed by the actual files and parameter indicating whether the tracer values should be looped (rewound) or not.</p>
<p>Oxygen_nFiles 1</p>
<p>Oxygen_File0.name inputs/forcisets/oxygen.nc</p>
<p>Oxygen_rewind 1</p>
<p>Oxygen_wgt_coefft 0.7</p>
<p>The weighting coefficient is what weight to put on the values being read into Atlantis (using a weighted average of Atlantis value and value from the forcing file – so a 1.0 means the read in value is used in place of the native Atlantis value, 0.0 means Atlantis value is used, a value between is a mix of the two)</p>
<p>(see <a href="https://confluence.csiro.au/display/Atlantis/2013/07/10/Read+in+forcing+data+for+tracers">instructions</a> also on the wiki).</p>
<p>Note, that the names of tracers provided in the tracerNames MUST exactly match the names in the <em>initial_conditions.nc</em> file, so that Atlantis knows which tracers to overwrite.</p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td><strong>NOTE!</strong> <strong>Forcing of tracers, especially those containing nitrogen, should be done with care, as it can easily affect the conservation of mass in the model</strong></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Forcing species distributions</p>
<p>use_move_entries 1</p></td>
<td><p>To change the distribution of species (for movement) you need to set the flag and then provide the following information for each group you wish to force (this example has two groups, FXX and FYY, and 2 stages)</p>
<p>nforceMoveGroups 4</p>
<p>MoveGroupCodes 4</p>
<p>FXX_stage_0</p>
<p>FXX_stage_1</p>
<p>FYY_stage_0</p>
<p>FYY_stage_1</p>
<p>Also list the distribution nc files - 1 file per "MoveGroupCode"</p>
<p>FXX_stage_0_File.name DistribFilename1.nc</p>
<p>FXX_stage_1_File.name DistribFilename2.nc</p>
<p>FYY_stage_0_File.name DistribFilename3.nc</p>
<p>FYY_stage_1_File.name DistribFilename4.nc</p>
<p>You must also provide the starting time for using the forcing (so it does not have to start on day 0 of the model simulation)</p>
<p>FXX_stage_0_tstart 0</p>
<p>FXX_stage_1_tstart 0</p>
<p>FYY_stage_0_tstart 0</p>
<p>FYY_stage_1_tstart 0</p>
<p>The format of the nc files and other relevant information is available in the section <em>Forcing the model distributions with species distribution models</em>.</p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>VI. Do final corrections and scaling</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Apply temperature, salinity and pH scalars to the biological processes</p>
<p><em>Ecology_Apply_Environ_ Scalars()</em> from <strong>atbiophyscis.c</strong> in <strong>atecology</strong></p></td>
<td><p>Runs optional scaling of biological processes by environmental conditions, such as temperature-, oxygen-, salinity-, pH- dependent feeding rates, mortality or other biological processes.</p>
<p>This will be described further in the Biology routines</p></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p>Update eddy values</p>
<p><em>Eddy_Strength_Update()</em> routine in <strong>atphysics.c</strong></p></td>
<td>Conducts linear interpolation of eddy strengths for the current day of the year from the quarterly box specific values given in eddy_S1, eddy_S2, eddy_S3 and eddy_S4.</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><p>Checks saturation values</p>
<p><em>Saturation_Check()</em> in <strong>atsaturation.c</strong></p></td>
<td>Checks that gases and nutrients haven't surpassed saturation values. If saturation values are exceeded, then concentrations are reset to the maximum saturation concentrations.</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><p>Get ice related information from input forcing files</p>
<p><em>Get_Ice()</em> in <strong>aticeIO.c</strong></p></td>
<td><p>Reads in ice properties for the current time step from TS or NC forcing files</p>
<p>Only executed if the <em>initial_conditions.nc</em> file has the global attribute icenz (see below and <a href="https://confluence.csiro.au/display/Atlantis/Ice+in+Atlantis">details</a> on wiki), which activates the ice model.</p></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Update time for writing outputs</td>
<td>Update the next time to write the values into <em>inputs.ts</em> and <em>exports.ts</em> files (see Table 3 on the contents of these files)</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="other-parameters-in-physics.prm-not-included-in-the-physics-routine" class="level2">
<h2 class="anchored" data-anchor-id="other-parameters-in-physics.prm-not-included-in-the-physics-routine"><strong>5.3. Other parameters in <em>physics.prm</em> not included in the <em>physics()</em> routine</strong></h2>
<p>Below are the remaining parameters and physics processes that were not described in the main <em>physics()</em> routine.</p>
<p><em>I. Resetting water column depths</em></p>
<p>wc_dz_tol: This parameter is used by <em>check_wc_dz()</em> routine in the <strong>atvertgeom.c</strong> file of the <strong>atphysics</strong> library. The routine checks the depth of water layers. Transport of water fluxes can in some cases cause too much flux into certain layers. This can be controlled by setting the maximum change in depth allowed in the wc_dz_tol parameter. The model will only allow this much fractional change before dz is reset to nominal value given in the <em>initial_conditions.nc</em> file by the nominal_dz variable. The wc_dz_tol parameter in many models is set to 0.2.</p>
<p>constrain_wc: This is a flag that is called in the <em>box_bio_process()</em> routine in <strong>atbiology.c</strong> and it resets the minimum water column depth to 1m if it becomes any shallower due to water fluxes. Turning this flag on is recommended in models that have a lot of shallow water areas and do not model sediment processes through multiple sediment layers explicitly. This avoids difficulties in modelling nutrient fluxes in very shallow waters.</p>
<p><em>II. Checks for the depth of sediment layer(s)</em></p>
<p>Same checks are done for the depth of sediment layers, which are controlled by maxseddz and minseddz parameters. The depth of the sediment layer(s) is controlled by the <em>check_sed_dz()</em> routine in <strong>atvertgeom.c</strong>. If the sediment layer depth gets too small the layer is merged with an adjacent sediment layer. If the sediment layer depth becomes too large it is split in two (made up of the original layer and a new inserted sediment layer). <strong>This is only used in models that have &gt;1 sediment layer!</strong> In models with only one sediment layer, there are no constraints on the thickness of the sediment layer.</p>
<p><em>III. Atmospheric deposition of gases and nutrients trapped in particulate matter</em></p>
<p>Atlantis has always allowed for atmospheric deposition of NH and NO, but this new functionality makes this explicit and allows users to modify atmospheric concentrations (mg per m<sup>3</sup>) of nutrients and gases trapped in particulate matter. Note, <strong>this is not the diffusion of gases through the water’s surface</strong>, which is dealt with in the <em>gasExchange()</em> routine. The atmospheric deposition is handled in respective nutrient routines in the <strong>atNutrient.c</strong> file in <strong>atecology</strong> library. To apply the atmospheric deposition, set include_atmosphere flag to 1 in the <em>physics.prm</em>. If the flag is set to 0 there will be no implicit deposition from the atmosphere.</p>
<p>If include_atmosphere is active then atmospheric concentrations (mg per m<sup>3</sup>) must be provided for the following seven nutrients and gases (example values given here are taken from the SETas model)</p>
<p>atmospheric_NH 0.017</p>
<p>atmospheric_NO 0.025</p>
<p>atmospheric_F 0.0</p>
<p>atmospheric_P 0.0</p>
<p>atmospheric_Si 0.0</p>
<p>atmospheric_O2 198.9</p>
<p>atmospheric_CO2 0.0</p>
<p><em>IV. Scaling of point sources</em></p>
<p>It is possible to scale the input of nutrients from point sources given in the TS files. This scaling might be useful if simulating increase or decrease of nutrient input through time. The scaling routines are activated with the flag nutrientchange. If the flag is set to 1, then a number of additional parameters should be provided, telling Atlantis how to scale the nutrients. The parameters required for scaling allow detailed scaling of each nutrient in each point source and are explained further on the <a href="https://confluence.csiro.au/display/Atlantis/Scaling+point+sources">wiki</a>.</p>
<p><em>V. Other parameters from old functionality</em></p>
<p>vdiffwt_wc: sets the scalar of water column diffusion and is used in the optional and currently rarely activated vertical and horizontal diffusion routines.</p>
<p>vdiffwt_sed: sets the scalar of diffusion in the sediments. It is used in the bioirrigation routine.</p>
<p>edge_type: a string of box-specific parameters describing the way box edges deal with water fluxes (0=standard, 1=absorptive, 2=reflective, 3=assymetrical scaling). This was used in the early days of Atlantis, when oceanographic files were not as sophisticated as they currently are and transport of tracers had to be manually adjusted. Setting different edge types for different boxes scaled the transport of tracers into and from the boxes. For current models, it is recommended to set the edge_type to 0 (standard) for all boxes.</p>
<p>biooxprofile: This was used in earlier Atlantis versions when the oxygen profile in the sediments was set and not dynamic. Currently the amount of oxygen in the sediments dynamically depends on the amount of biological activity and the parameter is not used.</p>
</section>
<section id="when-to-use-vertical-and-horizontal-transport-and-mixing" class="level2">
<h2 class="anchored" data-anchor-id="when-to-use-vertical-and-horizontal-transport-and-mixing"><strong>5.4. When to use vertical and horizontal transport and mixing?</strong></h2>
<p>The horizontal and vertical diffusion routines <em>hdiffBMwc()</em> and <em>atvdiffBMwc()</em> were created and used most often at a time when oceanographic models were still quite coarse and did not capture the water fluxes with sufficient accuracy. They are rarely used in current models. However, a number of issues still remain due to the loss of spatial resolution when converting files into the Atlantis model domain. This is where activating optional vertical mixing and filler horizontal diffusion routines might be useful:</p>
<p>1) <strong>Eddies</strong>. The spatial scale of most Atlantis models is too coarse for explicitly resolving oceanic eddies. Yet, eddies have a strong influence on productivity and oxygen content and ideally should be included in some form. The effect of eddies can be captured in two non-exclusive ways:</p>
<p>a) Eddy parameters (eddy_S1 to eddy_S4 and eddy_mixscale) parameters are used in the <em>Primary_Production()</em> routine to scale production. If some boxes are known to have strong eddies that amplify local production, the user can modify box- and season-specific eddy parameters to enhance production in certain boxes and certain seasons. The presence of eddies will scale the growth rate of primary producers, so that for the same nutrient concentration more growth is allowed (but of course, no growth is possible if no nutrients are available).</p>
<p>b) Eddy effect on productivity can be simulated by activating the <em>vertical_mixing()</em> routine, where mixing will be enhanced with box- and season-specific eddy scalars. Increased vertical mixing will bring more nutrients to upper water levels and will increase productivity in boxes identified through seasonal eddy_S1 to eddy_S4 values (which can differ box to box, showing relative eddy strength). Differences in vertical mixing intensity among boxes can be further tuned using the box-specific :vertmix parameter in the BGM file.</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th><p><strong>Good practice tip 4</strong></p>
<p>Eddies are not currently included in most models, but exploring their potential effect on the model outcomes is recommended. They provide a useful approach for adding spatial realism in primary productivity dynamics and may be particularly important in deeper waters and in systems where eddy effects are known to be strong.</p></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>2) <strong>Upwelling</strong>. The importance of upwelling for primary productivity is well recognised, but it is often difficult to capture the intensity of vertical mixing and nutrient input through the hydrodynamic forcing inputs alone. The latest oceanographic models are getting better in capturing upwelling through vertical fluxes, but in some cases Atlantis modellers might want to add an additional forced time series of point nutrient source into boxes where nutrient supply due to upwelling is not accurately captured. Upwelling would normally only be added into oceanic boxes, i.e.&nbsp;those that do not end with the sediment but with the open deep water boundary. The mixing of the forced nutrient input into the water column might have to be increased using the <em>vertical_mixing()</em> routine and by modifying box specific :vertmix parameter in the BGM file (or by using eddy_S1 to eddy_S4 parameters), to ensure the additional nutrients get properly mixed into the water columns.</p>
<p>Note, that the replenishment of nutrients in the deepest water column layers of the oceanic boxes may not require forced nutrient inputs, as it can be set with the mix_deep flag (see the description of the vertical diffusion routine above) and by normal vertical mixing. Yet, activating the mix_deep will only reset the nutrient concentrations in the deepest water layer to the nominal (initial) values given in the <em>initial_conditions.nc</em>. Oxygen can be added to the list of variables that are included in this representation of the replenishment from deep waters using mix_deep_O2 (by setting it to 1; 0 indicates Oxygen will not be included)</p>
<p>Including a separate input forcing file allows the user to specify time variable nutrient input throughout the year.</p>
<p>3) <strong>Absence of fluxes in small coastal boxes</strong>. Many oceanographic models, unless they were specifically built, still do not capture coastal processes with sufficient detail. This, combined with the loss of spatial resolution, can lead to isolated coastal boxes that receive no water fluxes (especially if the boxes are small or particularly shallow). This would naturally affect the model outcomes in such boxes, leading to high accumulation or depletion of nutrients and biomass.</p>
<p>Ideally, such issues should be resolved in cooperation with oceanographers who developed the models. If this is not possible, the filler horizontal diffusion routine will provide a very crude approximation of mixing for such boxes. Mixing can be further tuned with box specific mixing scalars (:vertmix and :hozirmix) in the BGM file.</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th><p><strong>Good practice tip 5</strong></p>
<p>The exploration of vertical and horizontal water fluxes is strongly recommended, especially during the model development stage. Currently there are two complementary ways to do it:</p>
<p>1. Use a <strong><em>shinyrAtlantis</em></strong> R package (see chapter 4.4) to plot fluxes through time and connections among boxes. The tool helps to identify isolated boxes, visualise intensity and direction of fluxes among boxes and also plot the magnitude of vertical fluxes in each box. The user can then compare these fluxes with the existing oceanographic knowledge and decide whether the intensity of vertical mixing should be increased or decreased using box-specific parameters.</p>
<p>2. Use passive inert tracers, such as sediments (SED in the <em>initial_conditions.nc</em>) to explore dispersal of particles through the model domain. Sediments are not acted upon by any organisms, so they won’t be eaten or decay (make sure :decay is 0). The initial concentrations of the tracer can be set in specific locations in the <em>initial_conditions.nc</em> file and their dispersal through the model domain followed in the model output. Alternatively, sediment inputs can be given in the TS files as forced point sources; and their dispersal from the point input locations can then be followed through time.</p></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</section>
<section id="latest-developments" class="level2">
<h2 class="anchored" data-anchor-id="latest-developments"><strong>5.5. Latest developments</strong></h2>
<p>New functionality is added to Atlantis almost every month. At the time of writing of this manual (April 2016) three significant new features were being tested: land, ice and contaminants. They are described here briefly, but the users are advised to check Atlantis wiki for further developments and instructions.</p>
<section id="land" class="level3">
<h3 class="anchored" data-anchor-id="land"><strong><em>5.5.1 Land</em></strong></h3>
<p>It is now possible to include <a href="https://confluence.csiro.au/display/Atlantis/Land+in+Atlantis">land</a> in Atlantis. The key reason to include this functionality is to allow explicit modelling of the movement of nutrients, organisms and human activity between land and water (groups can only make this transition if they are marked as being able to live on land and in the water in the <em>functional_groups.csv</em> file). It also allows for the future development of Atlantis into an integrated water-land model (so you can model land organisms). Currently this may be useful for shallow water areas, harbours and estuaries that have a lot of islands.</p>
<p>The optional land model is turned on by activating the flag flagAllowLand in the <em>run.prm</em> file. Land boxes are set up in the BGM file as having positive botz value. Land occupies water column layer 0 (bottom layer) and processes on land boxes are modelled in two-dimensional space, just like those for epibenthos. To obtain the total biomass, tracer values on land boxes are not multiplied by depth. It is also possible to include specific terrestrial tracers, by setting their bmtype = "terrestrial" in the <em>initial_conditions.nc</em> file. The values for these tracers would be stored in a different place than those for the water column tracers.</p>
</section>
<section id="ice" class="level3">
<h3 class="anchored" data-anchor-id="ice"><strong><em>5.5.2. Ice</em></strong></h3>
<p>Atlantis applications for the northernmost and southernmost domains (Barents Sea, Baltic Sea, Antarctica and others) have prompted the development of an explicit <a href="https://confluence.csiro.au/display/Atlantis/Ice+in+Atlantis">ice</a> model.</p>
<p>The optional ice model is activated when the <em>initial_conditions.nc</em> file has the global icenz variable included. This sets up the maximum number of ice layers. The ice model requires <a href="https://confluence.csiro.au/display/Atlantis/Changed+to+prm+files">ice forcing files</a> and their paths need to be identified in the <em>force.prm</em> (nInceFiles parameter in <em>force.prm</em>)</p>
<p>The <a href="https://confluence.csiro.au/display/Atlantis/Changed+to+prm+files">key characteristics of ice are described</a> in the wiki along with the additional parameters added to the <em>physics.prm</em> - these include maximum and minimum depth of an ice layer (maxicedz and minicedz), the number of ice classes, presence of slush, and specification of the ice model to use. The biological <a href="https://confluence.csiro.au/display/Atlantis/Ice+groups">groups</a> that are allowed in the ice include bacteria, diatoms, mixotrophs and small zooplankton. Activating the ice model requires a number of <a href="https://confluence.csiro.au/display/Atlantis/Changed+to+prm+files">new parameters in the <em>biology.prm</em></a> file too. These describe how to handle albedo, light attenuation, the depth consumers can dig into ice (the ice penetration depth of predators).</p>
</section>
<section id="contaminants" class="level3">
<h3 class="anchored" data-anchor-id="contaminants"><strong><em>5.5.3. Contaminants</em></strong></h3>
<p>It is now possible to track an unlimited number of <a href="https://confluence.csiro.au/display/Atlantis/Contaminants+in+Atlantis">contaminants</a> through the food chain. However, each contaminant requires specific new tracers tracking contaminant concentrations in each functional group (and each age group of fully age structured functional groups), which means significant changes to the input files and longer simulation run times. Each contaminant in the <em>initial_conditions.nc</em> is setup as a separate tracer (e.g.&nbsp;Arsenic). Because contaminants are tracked through all functional groups, a new contaminant tracer must be added for all tracked functional groups, e.g.&nbsp;Sed_Bact_Arsenic, Zoo_Arsenic, Cod1_Arsenic, Cod2_Arsenic, Cod3_Arsenic and so on.</p>
<p>The functional groups take up contaminants either through contact, general uptake or through consumption. For each functional group the user will have to provide a number of <a href="https://confluence.csiro.au/pages/viewpage.action?spaceKey=Atlantis&amp;title=Contaminants+in+Atlantis">new parameters in the <em>biology.prm</em></a> file: the uptake shape (linear or sigmoidal), uptake rate (mgm-<sup>3</sup> per second), 100% and 50% lethal concentration, and time to reach 50% mortality. It is also possible to include an additional contaminant effect on growth.</p>
<p>To set up contaminant tracking set the track_contaminants flag to 1 in the <em>run.prm</em> file and provide contaminant names and forcing files.</p>
<p>The definitions of contaminant tracers are added to the <em>run.prm</em> file. For example, if you want to add a single Arsenic tracer you would add the following to the <em>run.prm</em> file:</p>
<p># Set track contaminants to 1 to have active contaminants and 0 if no contaminants are desired</p>
<p>track_contaminants 1</p>
<p># The number of contaminants to read in</p>
<p>num_contaminants 1</p>
<p># Whether you need to check the contaminant fluxes (for the debugging or calibration of the contaminant model components)</p>
<p>flag_contam_sanity_check 1</p>
<p>To identify the contaminants, add an array of space separated contaminant names.</p>
<p>Atlantis will search for tracers with these names in the initial conditions file.</p>
<p>The number after contaminant names is the number of contaminant names to read in - same as other array definitions in the prm files.</p>
<p>contaminant_names 1</p>
<p>Arsenic</p>
<p>The units of the contaminants are entered as a space separated array.</p>
<p>contaminant_units 1</p>
<p>As/m^3</p>
<p>Atlantis will then expect the following tracer to be defined in the <em>initial_conditions.nc</em> model :</p>
<p>double Arsenic(t, b, z) ;</p>
<p>Arsenic:bmtype = "tracer" ;</p>
<p>Arsenic:units = "As/m^3" ;</p>
<p>Arsenic:long_name = "Amount of Arsenic" ;</p>
<p>Arsenic:sumtype = 1 ;</p>
<p>Arsenic:dtype = 0 ;</p>
<p>Arsenic:inwc = 0 ;</p>
<p>Arsenic:insed = 0 ;</p>
<p>Arsenic:dissol = 0 ;</p>
<p>Arsenic:decay = 0. ;</p>
<p>Arsenic:partic = 0 ;</p>
<p>Arsenic:_FillValue = 0. ;</p>
<p>For each contaminant tracer Atlantis must be provided with a forcing file in netcdf format (the file name and path is given in the <em>force.prm</em> file along with all other forcing time series). These can be all contained in a single netcdf file or with separate files per tracer. The following is an example forcing file in line with our example – the contaminant is for Arsenic in a model, for a model with 2 boxes and 3 water column layers. This example is for a single spill in a single box/layer of the model on the second time step in the file. This assumes the contaminant will be spread around the model using the existing transport model within Atlantis.</p>
<p>netcdf Arsenic_filename {</p>
<p>dimensions:</p>
<p>t = UNLIMITED ; // (3 currently)</p>
<p>b = 2 ;</p>
<p>z = 4 ;</p>
<p>variables:</p>
<p>double t(t) ;</p>
<p>t:units = "2005-01-01 00:00:00 +10" ;</p>
<p>t:dt = 86400. ;</p>
<p>double Arsenic(t, b, z) ;</p>
<p>Arsenic:_FillValue = -999. ;</p>
<p>Arsenic:missing_value = -999. ;</p>
<p>Arsenic:valid_min = 0. ;</p>
<p>Arsenic:valid_max = 300. ;</p>
<p>Arsenic:units = "As/m^3" ;</p>
<p>// global attributes:</p>
<p>:title = "trivial" ;</p>
<p>:geometry = "VMPA_setas.bgm" ;</p>
<p>:parameters = "" ;</p>
<p>data:</p>
<p>t = 0, 86400, 172800 ;</p>
<p>Arsenic =</p>
<p>_, _, _, _,</p>
<p>_, _, _, _,</p>
<p>0.1, _, _, _,</p>
<p>_, _, _, _,</p>
<p>_, _, _, _,</p>
<p>_, _, _, _ ;</p>
<p>}</p>
<p>To identify the forcing file enter the following into the force.prm file:</p>
<p>use_force_tracers 1</p>
<p># The number of tracers to search for in the files and the names of those tracers.</p>
<p>nforceTracers 1</p>
<p>tracerNames 1</p>
<p>Arsenic</p>
<p># Now the actual files. Can have more than one tracer in a file.</p>
<p>Arsenic_nFiles 1</p>
<p>Arsenic_File0.name Arsenic_filename.nc</p>
<p>Arsenic_rewind 0</p>
<p>Arsenic_File0.use_resets 0 #determines whether the values in Atlantis are reset or added to existing values</p>
<p><strong><em>Impact response functions</em></strong></p>
<p>The groups within Atlantis take up contaminants either through contact, general uptake or through consumption.</p>
<p>Some of the relevant&nbsp;parameters (which need to be added to the <a href="https://confluence.csiro.au/display/Atlantis/Changed+to+prm+files"><em>biology.prm</em></a> file) and processes are:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 13%">
<col style="width: 85%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Flag (parameter)</strong></th>
<th style="text-align: left;"><strong>Meaning&nbsp;</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">flag_dissolved_pollutants</td>
<td style="text-align: left;">Flag indicating whether the contaminants are dissolved and transmitted in excretion (1) or not (0)</td>
</tr>
<tr class="even">
<td style="text-align: left;">flag_contamMortModel</td>
<td style="text-align: left;">Flag indicating whether top use the simple mortality model from Laender et al 2008 (1) or compound model from InVitro (0)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flag_contamInteractModel</td>
<td style="text-align: left;">Flag indicating - No contaminant interactions (0), Additive interactions (1), Multiplicative interactions (2), Most limiting contaminant dominates (3)</td>
</tr>
<tr class="even">
<td style="text-align: left;">flag_contamGrowthModel</td>
<td style="text-align: left;">Flag indicating -&nbsp;No growth effects of contaminants (0), InVitro representation (1), logistic model (2)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flag_contamMove</td>
<td style="text-align: left;">Flag indicating the avoidance scalar used - 0 = none, 1 = knife-edge, 2 = sigmoidal, 3 = left shoulder flat top</td>
</tr>
<tr class="even">
<td style="text-align: left;">flag_contamOnlyAmplify</td>
<td style="text-align: left;">Flag indicating whether the interacting contaminants can only amplify (1) or can buffer/negate each other too (0)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flag_contamMinTemp</td>
<td style="text-align: left;">Flag indicating the minimum temperature to consider in contaminants relationships that involve temperature corrections (if the realised temperature is lower this minimum value is used instead)</td>
</tr>
<tr class="even">
<td style="text-align: left;">flag_detritus_contam</td>
<td style="text-align: left;">Flag indicating whether running contaminants through detritus</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flag_contam_halflife_spbased</td>
<td style="text-align: left;">Flag indicating whether half-life of contaminant is species specific</td>
</tr>
<tr class="even">
<td style="text-align: left;">flag_contamMaternalTransfer</td>
<td style="text-align: left;">Flag indicating whether maternal transfer enable</td>
</tr>
</tbody>
</table>
<p><em>Other relevant parameters:</em></p>
<p>Contaminants can also affect movement. There is the potential for mobile species (defined by the&nbsp;<em>VerticallyMigrates</em>&nbsp;and&nbsp;<em>HorizontallyMigrates</em>&nbsp;settings for the species in the f<em>unctional_groups.csv</em>&nbsp;file) to avoid the contaminants. It is not always appropriate biomass pool groups to show this behaviour so to turn it off set&nbsp;biopools_dodge_contam&nbsp;0 in the&nbsp;<em>biology.prm</em>.</p>
<p>For each of the contaminants the following parameetrs is required. For contaminant ZZZZ the coefficient indicating degree of dissolubility of the material (used if flag_dissolved_pollutants is set to 1, and determined for each contaminant - 1 all, 0 none) is set using ZZZZ_dissolv_coefft. Half life in seconds is set using ZZZZ_half_life. The flag indicating whether the contaminant effect is temperature dependent is<br>
ZZZZ_temp_depend.</p>
<p>For each functional group XXX the following is also required:</p>
<p>XXX_ZZZZ_uptake_rate - uptake rate (per day -&nbsp; will be converted to per second inside code).</p>
<p>XXX_ZZZZ_InstantDoseMortality – the instant dose contact mortality rate</p>
<p>XXX_ZZZZ_LD100 - the concentration that will kill 100% of the population.</p>
<p>XXX_ZZZZ_LD50 - the concentration that will kill 50% of the population.</p>
<p>XXX_ZZZZ_TimeToLD50 - the number of seconds that it takes to kill 50% of the population (based on Invitro code)</p>
<p>XXX_ZZZZ_avoid - the concentration where animals will begin avoiding the substance</p>
<p>XXX_ZZZZ_K_avoid - the constant used in the avoidance curve (for when there is a slow Gaussian tail to the&nbsp;response rather than a knife edge cut off)</p>
<p>Growth effects due to contamination can also be represented using the following parameters. For each species and each contaminant add</p>
<p>XXX_ZZZZ_GrowthThresh - the tissue contaminant level where growth effects start</p>
<p>XXX_ZZZZ_GrowthEffect - the size of the growth effect (as a scalar)</p>
<p>The flag setting the uptake model XXX_ZZZZ_uptake_option. This currently has three settings:</p>
<p>If set to 1 use a linear uptake (parameter is in parts/sec)</p>
<p><span class="math display">\[C_{a,t} = C_{a,t - 1} + dt \bullet \tau \bullet C_{c,t}\]</span></p>
<p>where <em>C<sub>a,t</sub></em> is the concentration of the contaminant in an agent at time <em>t</em>; <em>C<sub>c,t</sub></em> is the concentration in the water column (or sediments) and τ is the species specific contaminant uptake rate.</p>
<p>If set to 2 then use a sigmoid function</p>
<p><span class="math display">\[C_{a,t} = \frac{C_{a,t}'}{dt}\]</span></p>
<p><span class="math display">\[C_{a,t}' = \left( C_{c,t - 1}^{(1.0 - \varsigma)} - {\left( C_{c,t - 1}^{(1.0 - \varsigma)} - C_{a,t - 1}^{(1.0 - \varsigma)} \right) \bullet e}^{- \mu \bullet dt \bullet (\varsigma + 1.0)} \right)^{\left( \frac{1.0}{1.0 - \varsigma} \right)}\]</span></p>
<p>with <span class="math inline">\(\varsigma\)</span> the uptake constant (between 0 and 1, set to 0.99 by default) and the uptake rate.</p>
<p>And if set to 3 then an alternative sigmoidal uptake is used – this is ideal for representing interactions with a toxin that has no effect until a critical concentration is reached</p>
<p><span class="math display">\[C_{a,t} = \frac{C_{a,t}}{C_{a,t - dt} + \left( C_{a,t} - C_{a,t - dt} \right)e^{- \tau_{s}dt}}\]</span></p>
<p>If you want to allow for uptake of contaminants back out of detritus you also need to set flag_detritus_contam to 1.</p>
<p>Movement and reproduction can both be scaled due to level of contaminants in the organism using XXX_ZZZZ_MoveEffect and XXX_ZZZZ_ReprodEffect.</p>
<p>Maternal transfer is also possible (if the flag flag_contamMaternalTransfer is set to1) in which case the maternal transfer rates need to be set – both that for transfer during conception (recruitment) XXX_ZZZZ_maternal_transfer and during suckling (if have maternal care) XXX_ZZZZ_suckling_transfer.</p>
</section>
</section>
<section id="outputs-of-physics-tracers-in-the-output.nc-file" class="level2">
<h2 class="anchored" data-anchor-id="outputs-of-physics-tracers-in-the-output.nc-file"><strong>5.6. Outputs of physics tracers in the <em>output.nc</em> file</strong></h2>
<p>Values of physical variables throughout the simulation are reported in the main <em>output.nc</em> file. Although not usually analysed in standard simulations, it might be useful to explore these values during the model development stage.</p>
<p><span id="_Toc526762759" class="anchor"></span>Table 7. List and characteristics of physics variables given in the <em>output.nc</em> files (the same variables are given in the <em>initial_conditions.nc</em> file but without the time dimension).</p>
<table class="caption-top table">
<colgroup>
<col style="width: 3%">
<col style="width: 8%">
<col style="width: 87%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Name</strong></th>
<th><strong>Description, units</strong></th>
<th><strong>Comments</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>volume (t, b, z)</td>
<td>Volume of each cell at each time step, m<sup>3</sup></td>
<td>The volume changes due to water fluxes that simulate currents and tides. The change in the box’s volume is seen only as change in the depth and not surface area of the water column. The maximum fractional change in the depth is set by wc_dz_tol, if the depth exceeds this the depth is reset to the nominal_dz values given in the <em>initial_conditions.nc</em>. At present big tides will cause this reset, a flag to disable this is under development so please check the wiki for any updates.</td>
</tr>
<tr class="even">
<td><p>hdsource</p>
<p>(t, b, z)</p></td>
<td>Hydrodynamic sources, 1</td>
<td>A number of fluxes (number connections) into a given box – from other boxes and from itself</td>
</tr>
<tr class="odd">
<td>hdsink (t, b, z)</td>
<td>Hydrodynamic sinks, 1</td>
<td>A number of fluxes (number connections) from a given box – to other boxes and to itself</td>
</tr>
<tr class="even">
<td>eflux (t, b, z)</td>
<td>Hydrodynamic net horizontal exchanges, 1</td>
<td>Total inflow or outflow (positive/negative value) of water into the given cell in the horizontal direction</td>
</tr>
<tr class="odd">
<td>vflux (t, b, z)</td>
<td>Hydrodynamic net vertical exchanges, 1</td>
<td>Total inflow or outflow (positive/negative value) of water into the given cell in the vertical direction</td>
</tr>
<tr class="even">
<td>porosity (t, b, z)</td>
<td>Porosity of the sediment layer, 1</td>
<td>Fractional porosity of the sediment (from 0 to 1). Initial values are set in the <em>initial_conditions.nc</em>, but the property is dynamically calculated after (optional) settling of particulate tracers</td>
</tr>
<tr class="odd">
<td>nominal_dz, (b, z)</td>
<td>Thickness of a water layer, m</td>
<td>Initial or nominal depth of water column and sediment layers in each box. This is <strong>not a dynamic variable</strong>, as it does not have the time dimension. For all but the bottom water column layers the nominal depth is usually a round number (1 to a few hundred meters). The depth of the bottom water column layer varies depending on the terrain of the actual ecosystem (see Fig. 4).</td>
</tr>
<tr class="even">
<td>numlayers (t, b)</td>
<td>Number of layers</td>
<td>Number of layers in each box as set by the user. The number of layers is set in the <em>initial_conditions.nc</em> and currently remains stable through time. New functionality in the future might allow the number of water column layers to change due to large tides.</td>
</tr>
<tr class="odd">
<td>dz (t, b, z)</td>
<td>Thickness of a water layer, m</td>
<td>Dynamic thickness of the water layer, reflecting changes in its volume due to water fluxes (see volume variable above)</td>
</tr>
<tr class="even">
<td>topk (t, b)</td>
<td>Sediment top index</td>
<td>The sediment layer that has the interface with the water. In current models this is always 0, but the variable was used in the PPBIM when multiple dynamic sediment layers were modelled</td>
</tr>
<tr class="odd">
<td>sedbiodepth (t, b)</td>
<td>Depth of biological activity, m</td>
<td>Maximum depth of biological activity in the sediments. The shape of the profile of biological activity with depth is set in the biosedprofile in <em>physics.prm</em>. The actual depth of the activity will change depending on the amount of activity present and the oxygen levels</td>
</tr>
<tr class="even">
<td>seddetdepth (t, b)</td>
<td>Max depth of detritus, m</td>
<td>Depth of detritus in the sediment layer. It determines the depth of the habitat suitable for the infauna and changes through time due to sediment processes. It is dynamically calculated in <em>Bio_Box_Process()</em> routine in <strong><u>atbiology.c</u></strong>.</td>
</tr>
<tr class="odd">
<td>sedoxdepth (t, b)</td>
<td>Depth of oxygen horizon, m</td>
<td>Depth of the oxygenated sediment layer. The initial values are set in the <em>intial_condition.nc</em>, but the actual oxygen layer depth is dynamic and depends on the amount of oxygen in the water column and sediments, and amount of biological activity.</td>
</tr>
<tr class="even">
<td>sedbiodens (t, b)</td>
<td>Biological activity, Animals m<sup>2</sup></td>
<td>The “background density” of biological activity that is always present in the sediment. It is set by the user and can vary among boxes to reflect different quality of the sediment (see description of bioirrigation and bioturbation in chapter 5.2). Even though this variable has time dimension, it does not currently change through time</td>
</tr>
<tr class="odd">
<td>sedirrigenh (t, b)</td>
<td>Bioirrigation enhancement, 1</td>
<td>Scalar of bioirrigation enhancement due to action of infauna species (marked with _INF in the GroupType of the <em>functional_groups.csv</em> file). It is calculated in the <em>Irrig_and_Turb()</em> routine in <strong><u>atprocess.c</u></strong> in <strong>atecology</strong> library</td>
</tr>
<tr class="even">
<td>sedturbenh (t, b)</td>
<td>Bioturbation enhancement, 1</td>
<td>Scalar of bioturbation enhancement due to action of infauna species (marked with _INF in the GroupType of the <em>functional_groups.csv</em> file). It is calculated in the <em>Irrig_and_Turb()</em> routine in <strong><u>atprocess.c</u></strong> in <strong>atecology</strong> library</td>
</tr>
<tr class="odd">
<td>erosion_rate (t, b)</td>
<td>Erosion rate m/s</td>
<td>Dynamic erosion rate variable, which depends on the supplied bottom stress values and the topk variable</td>
</tr>
<tr class="even">
<td>eddy (t, b)</td>
<td>Eddy strength, 1</td>
<td>Eddy strength in each box at each time step, depending on the eddy seasonal values and scalars (see vertical mixing routine description in chapter 5.2)</td>
</tr>
</tbody>
</table>
</section>
<section id="importance-of-optional-physics-routines" class="level2">
<h2 class="anchored" data-anchor-id="importance-of-optional-physics-routines"><strong>5.7. Importance of optional physics routines</strong></h2>
<p>During the model development stage many people focus their attention on the parameters defining biological routines, while the <em>physics.prm</em> file is rarely touched. However, a number of optional routines included in the Physics submodel may have a large effect on the nutrient dynamics – bioirrigation, bioturbation, settling of particulate matter. This in turn is likely to have a large effect on biological groups and especially lower trophic levels. The example below is a quick analysis on the effect of turning some Physics routines off on total biomasses of functional groups in a Baltic Sea model. The model is still under development and is not presented in detail here.</p>
<p><img src="media/image32.jpg" style="width:6.69306in;height:5.08194in"></p>
<p><span id="_Toc526762789" class="anchor"></span>Figure 9. Total final biomass ratios of all Baltic Sea model functional groups in scenarios exploring the effects of optional physics routines. The simulations were run for 20 years.</p>
<p>Separate analysis was also done where six parameters in the <em>physics.prm</em> file defining bioturbation and bioirrigation intensity (typically in the range of 1e-7 to 1e-8) were increased 1000 times. The result is not shown but the effect was very minor, for most groups it made less than 5% difference in the final biomass compared to the scenario using same the physics routines but with default parameter values. Note, that the bioturbation routine is not included here, because the Baltic Sea model has only one sediment layer and hence the routine cannot be performed (setting bioturbation flag to 1 or 0 did not have any effect on biomasses).</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th><p><strong>Good practice tip 6</strong></p>
<p>It is recommended that while developing the model, users conduct a range of simulations with some of the optional routines turned on or off and explore different ways that physical and biological process might affect nutrient turnover.</p></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</section>
<section id="checking-hydrodynamic-transports" class="level2">
<h2 class="anchored" data-anchor-id="checking-hydrodynamic-transports"><strong>5.8. Checking hydrodynamic transports</strong></h2>
<p>In some instances you may want to track whether the transports are matching current patterns. To use it, update the code and</p>
<ol type="1">
<li>In run.prm add</li>
</ol>
<p>flagpassivetracer &nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp; # Flag indicating whether a passive tracer is needed for tracking tranpsorts or not (1 = yes, 0 = no)</p>
<ol start="2" type="1">
<li>In the in.nc file you need to add the tracer. In the header (text section at the start of the file) add the following</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; double SED(t, b, z) ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:bmtype = "tracer" ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:units = "mg N m-3" ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:long_name = "Passive tracer" ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:sumtype = 1 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:dtype = 0 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:inwc = 1 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:insed = 1 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:dissol = 0 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:decay = 0. ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:partic = 1 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:passive = 1 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:svel = 0. ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:xvel = 0. ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:psize = 1.e-06 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:b_dens = 1000000000. ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:i_conc = 200000000. ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:f_conc = 200000000. ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:isabs = 0 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:iscontam = 0 ;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SED:_FillValue = 0. ;</p>
<p>&nbsp;</p>
<p>Then in the data section of the file you need to add</p>
<p>SED =</p>
<p>&nbsp; N, _, _,;</p>
<p>Where N is the tracer doping you want to use if you want it to be there at the start of the model. You could also introduce it later on as a point source. Let me know if you want to do that (its like adding a river inputs so really straight forward).</p>
<p>As to the _ you need as many data entries in total as there are layers (water column + sediment layers) * number of boxes in the model (lets call that value “LxB”. Now the N needs one entry so the total number of _ you need is (LxB -1)</p>
<p>So for a model with 3 layers in 4 boxes where N is entering in box 1 you would have</p>
<p>SED =</p>
<p>&nbsp; _, _, _,&nbsp;</p>
<p>&nbsp;&nbsp;N, _, _,</p>
<p>&nbsp; _, _, _,</p>
<p>&nbsp; _, _, _ ;</p>
<p>At present it really only makes sense to dope one location at a time with the N otherwise you won’t know where things have come from as you can’t have more than one SED variable at a time. If multiple tracer types are required please contact the developers.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>