<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Atlantis Documentation – 4. HYDRODYNAMIC, SALINITY AND TEMPERATURE FORCING DATA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Atlantis Documentation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-user-guides" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">User Guides</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-user-guides">    
        <li>
    <a class="dropdown-item" href="../../../user_guides/quarto_site/part1/index.html">
 <span class="dropdown-text">Part I - Atlantis User Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../user_guides/quarto_site/part2/index.html">
 <span class="dropdown-text">Part II - [Coming Soon]</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../confluence/index.html"> 
<span class="menu-text">Confluence Wiki</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../resources/index.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../user_guides/quarto_site/part1/05-hydrodynamic-salinity-and-temperature-forcing-data.html">4. Hydrodynamic, Salinity and Temperature Forcing Data</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/01-foreward.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Foreword</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/02-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/03-installation-and-running.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. Installation and Running</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/04-geometry-of-the-model-domain.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Geometry of the Model Domain</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/05-hydrodynamic-salinity-and-temperature-forcing-data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">4. Hydrodynamic, Salinity and Temperature Forcing Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/06-the-physics-submodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5. The Physics Submodel</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/07-definitions-of-functional-groups.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6. Definitions of Functional Groups</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/08-run-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7. Run Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/09-force-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8. Force Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/10-primary-producer-processes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9. Primary Producer Processes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/11-consumer-processes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10. Consumer Processes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/12-distribution-and-movement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11. Distribution and Movement</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/13-processes-in-bacterial-and-inanimate-pools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12. Processes in Bacterial and Inanimate Pools</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/14-influence-of-environmental-factors-on-ecological-p.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">13. Influence of Environmental Factors on Ecological Processes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/15-final-overview-of-ecology-routines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">14. Final Overview of Ecology Routines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/16-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../user_guides/quarto_site/part1/17-appendix-1-tips-for-calibrating-biological-model-n.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix 1: Tips for Calibrating Biological Model</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#general-introduction-to-forcing-of-atlantis-models" id="toc-general-introduction-to-forcing-of-atlantis-models" class="nav-link active" data-scroll-target="#general-introduction-to-forcing-of-atlantis-models"><strong>4.1. General introduction to forcing of Atlantis models</strong></a></li>
  <li><a href="#transforming-oceanographic-model-output-into-atlantis-forcing-files" id="toc-transforming-oceanographic-model-output-into-atlantis-forcing-files" class="nav-link" data-scroll-target="#transforming-oceanographic-model-output-into-atlantis-forcing-files"><strong>4.2. Transforming oceanographic model output into Atlantis forcing files</strong></a></li>
  <li><a href="#things-to-keep-in-mind-about-hydrodynamic-forcing-files" id="toc-things-to-keep-in-mind-about-hydrodynamic-forcing-files" class="nav-link" data-scroll-target="#things-to-keep-in-mind-about-hydrodynamic-forcing-files"><strong>4.3. Things to keep in mind about hydrodynamic forcing files</strong></a></li>
  <li><a href="#numbering-of-vertical-layers-in-the-input-and-output-nc-files" id="toc-numbering-of-vertical-layers-in-the-input-and-output-nc-files" class="nav-link" data-scroll-target="#numbering-of-vertical-layers-in-the-input-and-output-nc-files"><strong>4.4. Numbering of vertical layers in the input and output NC files</strong></a></li>
  <li><a href="#viewing-and-checking-forcing-input-files-with-r" id="toc-viewing-and-checking-forcing-input-files-with-r" class="nav-link" data-scroll-target="#viewing-and-checking-forcing-input-files-with-r"><strong>4.5. Viewing and checking forcing input files with R</strong></a></li>
  <li><a href="#light-and-noise-pollution" id="toc-light-and-noise-pollution" class="nav-link" data-scroll-target="#light-and-noise-pollution"><strong>4.6. Light and noise pollution</strong></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">4. HYDRODYNAMIC, SALINITY AND TEMPERATURE FORCING DATA</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="general-introduction-to-forcing-of-atlantis-models" class="level2">
<h2 class="anchored" data-anchor-id="general-introduction-to-forcing-of-atlantis-models"><strong>4.1. General introduction to forcing of Atlantis models</strong></h2>
<p>Like most other ecosystem models, Atlantis does not calculate water fluxes (current, circulation) itself, but uses outputs from specialised oceanographic models such as <a href="https://www.myroms.org/wiki/Documentation_Portal">ROMS</a> (Regional Ocean Modeling System) (Shchepetkin and McWilliams 2005; Haidvogel et al.&nbsp;2008), <a href="http://wp.csiro.au/bluelink/global/">BLUELINK</a> (Brassington et al.&nbsp;2007) or <a href="https://hycom.org/">HYCOM</a> (Chassignet et al.&nbsp;2006). In other words, Atlantis models are forced with hydrodynamic data from oceanographic models. At the minimum level Atlantis requires only a hydrodynamic forcing input file defining water fluxes across boxes and layers. The model will then use simple routines to calculate temperature and salinity conditions in each cell at each simulation time step. However, most Atlantis models, and other ecosystem models (Fiechter et al.&nbsp;2014; Rose et al.&nbsp;2015), also use oceanographic model output to force temperature and salinity conditions (and in some cases also oxygen, pH or other tracers). This is because oceanographic models are specialised to model temperature and salinity conditions, and their calculation of these parameters are deemed to be more accurate than those used in Atlantis. Moreover, taking the physical properties from the oceanographic model means they are consistent with the exchanges (currents) being read in from the oceanographic model. In rare cases, if oceanographic models are not available, water flux information can be pieced together from observations or literature to generate hydrodynamic forcing files manually. Table 5 lists some of the spatial domains and forcing characteristics of example model applications.</p>
<p>Oceanographic models simulate processes on their native grid, which is typically of much higher spatial resolution than Atlantis. The temporal scale in oceanographic models is also often in the range of seconds rather than the 6h, 12h or 24h used in Atlantis. Further, most oceanographic models use the same number of water column layers regardless of total depth (called sigma layers) (Fig. 6). This means that the depth of a layer in oceanographic models is very different in shallow and deep waters, while in Atlantis, water layer depths remain relatively stable (with small variations due to tides). This means that water fluxes and values of all forced parameters must be interpolated onto Atlantis model polygons and cells.</p>
<p><strong>Table 5.</strong> Hydrodynamic structure of some example Atlantis models. Advect = advection, temp = temperature, salt = salinity.</p>
<div class="table-responsive">
<table class="caption-top table">
<colgroup>
<col style="width: 1%">
<col style="width: 12%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 12%">
<col style="width: 5%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>SE Australia</th>
<th>Eastern Tasmania</th>
<th>Port Phillip Bay</th>
<th>Western-port</th>
<th>NEUS</th>
<th>California current</th>
<th>Gulf of California</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Key oceanographic effects</strong></td>
<td>Boundary currents</td>
<td>Boundary current, upwelling</td>
<td>River input and slow flushing</td>
<td>River input and flushing</td>
<td>Gulf Stream, Boundary current, Georges Bank</td>
<td>Boundary current, upwelling, El Nino</td>
<td>Colorado River input, tidal mixing / stratification</td>
</tr>
<tr class="even">
<td><strong>Number of boxes</strong></td>
<td>71</td>
<td>11</td>
<td>60</td>
<td>27</td>
<td>30</td>
<td>62</td>
<td>66</td>
</tr>
<tr class="odd">
<td><strong>Max number of water column layers</strong></td>
<td>5</td>
<td>6</td>
<td>1</td>
<td>1</td>
<td>4</td>
<td>7</td>
<td>6</td>
</tr>
<tr class="even">
<td><strong>Ocean boundary depth</strong></td>
<td>2400m</td>
<td>2400m</td>
<td>45m</td>
<td>30m</td>
<td>200m</td>
<td>1200m</td>
<td>2025m</td>
</tr>
<tr class="odd">
<td><strong>Hydrodynamic model used to supply flows</strong></td>
<td>OFAM-Bluelink¹</td>
<td>OFAM-Bluelink</td>
<td>3D hyrdro model²</td>
<td>Empirically defined</td>
<td>HYCOM³</td>
<td>ROMS⁴</td>
<td>ROMS⁵</td>
</tr>
<tr class="even">
<td><strong>Hydrodynamic time series length (years)</strong></td>
<td>10</td>
<td>10</td>
<td>5</td>
<td>1</td>
<td>1</td>
<td>7</td>
<td>23</td>
</tr>
<tr class="odd">
<td><strong>Transport model variables</strong></td>
<td>Advect, temp, salt</td>
<td>Advect, temp, salt</td>
<td>Advect</td>
<td>Advect</td>
<td>Advect, temp, salt</td>
<td>Advect, temp, salt</td>
<td>Advect, temp, salt</td>
</tr>
<tr class="even">
<td><strong>Environmental drivers</strong></td>
<td>Inshore sediment change, temp, pH, nutrients, river flow</td>
<td></td>
<td>Nutrients</td>
<td>Nutrients</td>
<td>Nutrients</td>
<td>Temp, nutrients</td>
<td>Temp, nutrients, river flow</td>
</tr>
<tr class="odd">
<td><strong>Climate change</strong></td>
<td>Yes</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>Yes (impl.)⁶</td>
<td>No</td>
</tr>
<tr class="even">
<td><strong>Explicit larval advection</strong></td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
</tr>
</tbody>
</table>
</div>
<p><strong>Notes:</strong> - ¹ Oke et al 2005 - ² Walker 1997a, 1997b - ³ hycom.rsmas.miami.edu/las/ - ⁴ ROMS Hermann – NOAA PMEL/JISAO, Seattle - ⁵ ROMS Pares-Sierra - Centro de Investigación Científica y de Educación Superior de Ensenada - ⁶ Implicit handling of climate change means that extra mortality terms (related to acidification) or forced changes (e.g.&nbsp;for temperature) are used rather than flows from down scaled global circulation models</p>
<p><img src="media/image26.png" style="width:4in;height:6in"></p>
<p><span id="_Toc526762786" class="anchor"></span><strong>Figure 6.</strong> An example of oceanographic sigma depth layers (grey lines) with an overlay of Atlantis spatial structure. Figure by Javier Porobic Garate</p>
</section>
<section id="transforming-oceanographic-model-output-into-atlantis-forcing-files" class="level2">
<h2 class="anchored" data-anchor-id="transforming-oceanographic-model-output-into-atlantis-forcing-files"><strong>4.2. Transforming oceanographic model output into Atlantis forcing files</strong></h2>
<p>The interpolation of the oceanographic output into Atlantis forcing files requires transformation across different shaped grids and depth layers. Water fluxes must be transformed from the oceanographic grid to Atlantis faces, whereas temperature and salinity values must be averaged onto Atlantis cells and time steps. The transformation must also account for hyperdiffusion, which is caused by the different spatial scales of oceanographic and Atlantis models. Because concentration of tracers within a layer of a box is assumed to be uniform, a tracer that enters a box is instantaneously assumed to be equally distributed throughout the entire box. This means that flow of tracers in large boxes would be overstated by orders of magnitude if this hyperdifussion phenomenon is not taken into account. The (crude) correction simply divides the east-west water flows by the width of the box (in metres) in the east-west orientation and north-south flows by the width of the box in the north-south orientation. This is a simple and a standard approach to correct for hyperdifusion and can be further refined using the horiz_mix scalar in the BGM file.</p>
<p>Fortunately, the transformation of oceanographic files is increasingly streamlined. Until recently most model developers used two codes contributed by CSIRO. We will describe them in a more detail below. However, new codes are currently being developed by the Atlantis community, i.e.&nbsp;an <a href="https://confluence.csiro.au/display/Atlantis/R+code+to+process+ROMS+into+Hydro">R script by Cecilia Hansen</a> to construct hydrodynamic files from ROMS files. Please check the Atlantis wiki <a href="https://confluence.csiro.au/display/Atlantis/Forcing+Files">forcing files page</a> and Atlantis google group for any new developments in this area.</p>
<p>The interpolation of oceanographic data onto the Atlantis model geometry requires three main conversions (Fig. 7):</p>
<ol type="1">
<li>Calculate <strong>horizontal</strong> water fluxes across Atlantis polygon faces, i.e.&nbsp;from one polygon to another</li>
<li>Calculate <strong>vertical</strong> water fluxes within Atlantis polygons.</li>
<li>Calculate <strong>state variables</strong> used for optional forcing, such as salinity and temperature for each cell and time step. For this step temperature and salinity values from high resolution oceanographic models are mapped onto Atlantis cells and a weighted average for each cell is calculated</li>
</ol>
<p>These three steps constitute the main conversion and are conducted using the <a href="https://confluence.csiro.au/display/Atlantis/Matlab+-+Hydro"><em>Hydro</em></a> Matlab script (follow the link for further instructions on installation and use of the <em>Hydro</em> script and also check <a href="https://confluence.csiro.au/display/Atlantis/Hydro+FAQ"><em>Hydro</em> FAQ</a> for more information). <em>Hydro</em> produces two NC files which are then used by <a href="https://confluence.csiro.au/display/Atlantis/HydroConstruct"><em>Hydroconstruct</em></a> to produce the final Atlantis forcing files. <em>Hydroconstruct</em> makes sure the order of water columns is in the right direction, transforms the water flux data into per layer per box fluxes and also corrects for hyperdifussion (using either area based scaling or area and box shape based scaling). The <em>Hydroconstruct</em> <a href="https://confluence.csiro.au/display/Atlantis/Running+Hydroconstruct">running</a> page and <a href="https://confluence.csiro.au/display/Atlantis/Running+Hydroconstruct?preview=/43155480/43156182/params_17July2012.prm">parameter</a> file provides further information on the script and how to run it.</p>
<p><img src="media/image27.jpeg" style="width:6.88958in;height:2.22639in"></p>
<p><span id="_Toc526762787" class="anchor"></span><strong>Figure 7.</strong> Main steps in converting oceanographic files into Atlantis input files, as done using two CSIRO contributed scripts <em>Hydro</em> and <em>Hydroconstruct</em>. Figure by Javier Porobic Garate</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Good practice tip 3">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Good practice tip 3
</div>
</div>
<div class="callout-body-container callout-body">
<p>Interpolation and interpretation of the oceanographic data is one of the main challenges for Atlantis models developers and users, because usually they are biologists and not oceanographers. It is therefore highly recommended to include an oceanographer in the Atlantis team, at least during the model development stage, but also if and when long term forcing of environmental trends is needed.</p>
</div>
</div>
</section>
<section id="things-to-keep-in-mind-about-hydrodynamic-forcing-files" class="level2">
<h2 class="anchored" data-anchor-id="things-to-keep-in-mind-about-hydrodynamic-forcing-files"><strong>4.3. Things to keep in mind about hydrodynamic forcing files</strong></h2>
<p>Oceanographic modelling has made rapid progress in recent years and availability of high resolution data is increasing, but there are still a <strong>few issued that should be kept in mind:</strong></p>
<ol type="1">
<li><strong>Absence of long term oceanographic data to study long term trends.</strong> Oceanographers rarely conduct 50+ years of high resolution simulations, yet such time frames are often needed for Atlantis simulations. The length of oceanographic data time series usually more on the order of 1 to 25 years (see Table 5 for examples) and a common practice among Atlantis users is to ‘loop’ over the available oceanographic input years. One should be aware that if long term trends are present in the oceanographic data, they will be seen as jumps in average variable values every time the file is recycled. Also, such recycling alone is not suitable for studying long term environmental trends. Ideally long term forcing files should be obtained directly from long term oceanographic simulations.</li>
</ol>
<p>As a crude approximation, <strong>long term trends can be forced</strong> onto hydrodynamic files using an <a href="https://confluence.csiro.au/display/Atlantis/R+code%2C+add+climate+trends+to+Hydro.NC">R script</a> contributed by Hem Nalini Morzaria Luna and used for the Gulf of California model. Alternatively, trends in temperature, salinity and pH can be added in the biology.prm file using several Tchange, Schange and PHchange parameters (see below)</p>
<ol start="2" type="1">
<li><p><strong>Insufficient resolution in coastal areas</strong>. Most oceanographic global and publicly available models do not include coastal areas at sufficiently high resolution (in many old models they are not represented at all). Yet this is where a lot of important processes of nutrient input, recycling, spawning and larval dispersal take place. It is therefore very important to assess the water fluxes in small or shallow coastal areas and make sure that they are sufficiently accurate (see below).</p></li>
<li><p><strong>Loss of resolution to represent eddies and upwelling.</strong> Translating high resolution oceanographic models to the Atlantis polygons means that transformed forcing files may not capture the true magnitude of eddy strength or local upwelling, both of which are important for driving local productivity. To compensate for this loss of resolution it is recommended that local forcing of productivity be included using eddy parameters (see below) and/or forcing additional nutrient loading into coastal waters (to simulate upwelling; Brand et al.&nbsp;2007).</p></li>
<li><p><strong>Oceanographic models can include ‘drift’</strong>, temporal artefact trends that bias long-term oceanographic outputs. If ‘drift’ is seen to be a problem, modellers can choose a limited set of years of oceanographic output and loop these years.</p></li>
<li><p><strong>Artificially inflated vertical fluxes.</strong> Sometimes oceanographic models can inflate the vertical fluxes (they are used for tuning the horizontal fluxes), which can lead to too much vertical mixing. This is becoming less of a problem as the skill of oceanographic models improves with time, but it is still recommended to check the intensity of vertical fluxes. If vertical fluxes appear to be too strong they can be downscaled using vertical diffusion and vertical mixing routines (see below) or by using an R script contributed by Raphael Girardin (details and a link will be added when available, but also check the wiki). Similat ‘jets’ can appear in horizontal fluxes (particularly in older models and most often close to the boundary of the oceanographic model domain).</p></li>
<li><p><strong>Underestimated diffusion of tracers between boxes</strong>. In real world there are lots of bi-directional flows between spatial domains that are modelled as distinct Atlantis boxes. However, when these flows are converted into hydrodynamic forcing files, all flows are averaged for each pair of cells, so that only one-directional flow occurs between two cells at each time step. This might under-represent diffusion of tracers between boxes, especially if boxes are large and if averages all go in the same direction in all layers of the two boxes.</p></li>
</ol>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>NOTE!</strong></p>
<p>The <strong>hydrodynamic forcing files</strong> <strong>are automatically</strong> recycled or <strong>looped</strong> for the entire model simulation run. This is <strong>not the case</strong> with other forcing files, such as temperature, salinity or other optional forcing files. To rewind the temperature and salinity forcing files set the flags temp_rewind and salt_rewind to 1 in the force.prm file. If the flags are set to 0 then the simulations will use the last temperature and salinity value once the forcing file time series ends. To rewind any other optional forced tracers make sure you set TracerName_rewind (e.g.&nbsp;pH_rewind) parameter to 1.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>NOTE!</strong></p>
<p>The hydrodynamic forcing files <strong>are not necessarily the final water transport</strong> in your model. They provide the horizontal and vertical water fluxes, which are then used in the transport model described in the <em>(transportBM)</em> routine in the attransport.c file.</p>
<p>The transport model uses the water exchanges from the hydrodynamic forcing files, but can also:</p>
<ol type="1">
<li>apply water flow corrections to isolated boxes according to specified parameters</li>
<li>add local water inputs or sinks, such as river flows or outflows</li>
<li>apply water exchanges through the surface layer due to precipitation and evaporation</li>
</ol>
<p>The final flows of water are given in the output.nc file listed in hdsource, hdsink, eflux and vflux (see description of the ouput file parameters in chapter 5.6). If some of the optional physics routines are used, then these final exhcanges may be different from the hydrodynamic forcing inputs.</p>
</div>
</div>
</section>
<section id="numbering-of-vertical-layers-in-the-input-and-output-nc-files" class="level2">
<h2 class="anchored" data-anchor-id="numbering-of-vertical-layers-in-the-input-and-output-nc-files"><strong>4.4. Numbering of vertical layers in the input and output NC files</strong></h2>
<p><img src="media/image29.png" style="width:1.18889in;height:4.32292in"></p>
<p>Atlantis allows users to define several water column and sediment layers, although most applications have only one sediment layer.</p>
<p>Layer counting starts from the sediment-water interface.</p>
<p>The water layer 0 is always closest to the sediment, the next layer up is layer 1 and so on. Sediment layer 0 is closest to the water, the next layer down is 1 and so on.</p>
<p>In the.nc files water column layers are listed first, followed by the sediment layers.</p>
<p><em>layer 0, layer 1, layer 2, layer 3, layer 4, layer 5, sediment 0</em></p>
<p>In the model setup shown here, the layer corresponding to the water column’s surface layer can be anything from layer 0 to layer 5, depending on the total depth of a box. In deep boxes the surface layer will be layer 5, while for the shallowest boxes the surface will have layer 0 as their surface layer.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>NOTE!</p>
<p>The ordering of layers in output files is opposite to that in the input file. This is a development legacy aimed to improve the viewing of output files with NC file viewers. This also means that the position of missing water column layers in arrays describing boxes with fewer than maximum layers is reversed between the input and output files.</p>
<p>In the input.nc file a shallow water box with three water layers will look like:</p>
<p><em>layer 0, layer 1, layer 2, 0, 0, 0, sediment 0</em></p>
<p>In the output.nc file the same box will look like:</p>
<p><em>0, 0, 0, layer 0, layer 1, layer 2, sediment 0</em></p>
</div>
</div>
<p>A good way to understand this is to look at temperature variables. Note that warmer water is on the surface.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 48%">
<col style="width: 51%">
</colgroup>
<thead>
<tr class="header">
<th>Input.nc file:</th>
<th>Output.nc file:</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Temp =<br>15.75, 18.54, 18.55, 0, 0, 0, 11.85,<br>16.38, 17.64, 17.49, 0, 0, 0, 11.77,<br>15.66, 17.34, 17.31, 0, 0, 0, 11.57,<br>16.05, 16.92, 16.87, 0, 0, 0, 11.29,<br>5.15, 11.85, 13.92, 17.02, 19.01, 19.83, 0.32,<br>5.29, 11.91, 13.85, 16.39, 18.50, 19.48, 0.93,<br><br>…</td>
<td>Temp =<br><br>0, 0, 0, 15.75, 18.54, 18.55, 11.85,<br><br>0, 0, 0, 16.38, 17.64, 17.49, 11.77,<br><br>0, 0, 0, 15.66, 17.34, 17.31, 11.57,<br><br>0, 0, 0, 16.05, 16.92, 16.87, 11.29,<br><br>5.15, 11.85, 13.92, 17.02, 19.01, 19.83, 0.32,<br><br>5.29, 11.91, 13.85, 16.39, 18.50, 19.48, 0.93,<br><br>…</td>
</tr>
</tbody>
</table>
</section>
<section id="viewing-and-checking-forcing-input-files-with-r" class="level2">
<h2 class="anchored" data-anchor-id="viewing-and-checking-forcing-input-files-with-r"><strong>4.5. Viewing and checking forcing input files with R</strong></h2>
<p>An R-package <strong><em>shinyrAtlantis</em></strong> is available on <a href="https://github.com/shanearichards/shinyrAtlantis" class="uri">https://github.com/shanearichards/shinyrAtlantis</a> and provides a number of shiny applications to help with viewing Atlantis forcing and parameter files.</p>
<p>For exploring hydrodynamic forcing files the package provides a function ‘make.exchange.object' that reads in the BGM file containing box geometries and the NC file containing the exchanges. The function ’make.exchange.object’ also needs to be provided with the cumulative layer depths. It then produces a data object that can be fed into the shiny application ‘sh.exchange’. The ‘sh.exchange’ provides a visual description of the exchange data. It visualises connections and exchanges among boxes and layers and helps to identify if any boxes are isolated. A time-series of exchanges for each box can also be generated, as well as a two-dimensional visualisation of the horizontal flow throughout the domain. Development is under way to add visualisation of the salinity and temperature forcing files.</p>
</section>
<section id="light-and-noise-pollution" class="level2">
<h2 class="anchored" data-anchor-id="light-and-noise-pollution"><strong>4.6. Light and noise pollution</strong></h2>
<p>A simple representation of noise and light pollution from human sources can be represented as a forcing file. More advanced code linking this pollution to levels of human activity is present in the development branch but not the trunk as yet. In the main trunk code, for now the levels of noise and light pollution must be entered in a forcing NC file in the same way as salinity or temperature.</p>
<p>To activate and load this pollution you need to</p>
<ul>
<li><p><em>run.prm file</em>: set flag_pollutant_impacts to 1</p></li>
<li><p><em>forcing.prm file</em>: set use_pollutantfiles to 1 and then</p></li>
</ul>
<p>nnoise_pollutionfiles X (where X is the number of noise forcing files)</p>
<p>Noise_Pollution0.name path/noise_filename.nc</p>
<p>noise_pollution_rewind 1 (set to 0 if you do not want the file(s) to be rewound and reused)</p>
<p>nlight_pollutionfiles X (where X is the number of light pollution forcing files)</p>
<p>Light_Pollution0.name path/light_pollution_filename.nc</p>
<p>light_pollution_rewind 1 (set to 0 if you do not want the file(s) to be rewound and reused)</p>
<ul>
<li><em>biology.prm</em> <em>file</em>: Add the parameters noise_coefft_XX and light_coefft_XX for each biological group</li>
</ul>
<!-- -->
<ul>
<li><em>groups.csv:</em> Add the columns isLightEffected and isNoiseEffected and set the value to 1 for these if you want noise/light pollution to affect that species group</li>
</ul>
<p>For any groups that are affected then during movement an additional scalar (<span class="math inline">\(\delta_{\mathbb{N}}\)</span>) is applied to each box (making a site less attractive to the species), with:</p>
<p><span class="math inline">\(\delta_{\mathbb{N}} = \ \frac{\kappa_{\eta,s}}{\mathbb{N}_{i,j}}\)</span></p>
<p>Where <span class="math inline">\(\mathbb{N}_{i,j}\)</span> represents the level of the pollutant (noise or light) in layer <em>j</em> of polygon (box) <em>i</em>; and κ<sub>η,s</sub> is the coefficient for that pollutant type.</p>
<p>In addition, metabolic parameters – consumption (C) and growth rates (mum) – are scaled in the same way; while starvation and background (mL, mQ) mortality rates are scaled by the inverse.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>